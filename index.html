<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NEXUS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëÅÔ∏è</text></svg>">
    
    <title>NEXUS TERMINAL</title>
    
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           NEXUS TERMINAL v6.0 - BLADE RUNNER 2019 ULTIMATE EDITION
           Full CRT effects, VHS glitch, rain, chromatic aberration
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg: #000000;
            --bg-light: #040808;
            --fg: #00F0D0;
            --fg-dim: #009080;
            --fg-dark: #004540;
            --fg-bright: #00FFF0;
            --accent: #FF2E97;
            --warning: #FFB800;
            --danger: #FF3355;
            --cyan: #00FFFF;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        [data-theme="purple"] {
            --fg: #C090FF;
            --fg-dim: #8855DD;
            --fg-dark: #442288;
            --fg-bright: #E1BEE7;
            --accent: #FF4081;
        }
        
        [data-theme="amber"] {
            --fg: #FFA000;
            --fg-dim: #CC7700;
            --fg-dark: #664400;
            --fg-bright: #FFB74D;
            --accent: #00E5FF;
        }
        
        body {
            font-family: 'Share Tech Mono', 'Monaco', monospace;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            padding-top: var(--safe-top);
            font-size: 13px;
            line-height: 1.5;
            text-transform: uppercase;
            overflow-x: hidden;
        }
        
        /* ‚ïê‚ïê‚ïê CRT SCANLINES - HEAVY 80s STYLE ‚ïê‚ïê‚ïê */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.3) 0px,
                rgba(0, 0, 0, 0.3) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }
        
        /* ‚ïê‚ïê‚ïê CRT VIGNETTE + PHOSPHOR GLOW + INTERLACE ‚ïê‚ïê‚ïê */
        body::after {
            content: '';
            position: fixed;
            top: -5%; left: -5%; right: -5%; bottom: -5%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 240, 208, 0.02) 0px,
                    transparent 1px,
                    transparent 3px
                ),
                /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –±–æ–∫–∞–º */
                linear-gradient(
                    90deg,
                    rgba(0, 0, 0, 0.6) 0%,
                    rgba(0, 0, 0, 0.25) 8%,
                    transparent 20%,
                    transparent 80%,
                    rgba(0, 0, 0, 0.25) 92%,
                    rgba(0, 0, 0, 0.6) 100%
                ),
                /* –†–∞–¥–∏–∞–ª—å–Ω–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ */
                radial-gradient(
                    ellipse at center,
                    transparent 0%,
                    transparent 45%,
                    rgba(0, 0, 0, 0.3) 70%,
                    rgba(0, 0, 0, 0.6) 100%
                );
            pointer-events: none;
            z-index: 9998;
            animation: interlace 0.15s steps(2) infinite;
        }
        
        @keyframes interlace {
            0% { background-position: 0 0; }
            100% { background-position: 0 2px; }
        }
        
        /* ‚ïê‚ïê‚ïê SCREEN FLICKER ‚ïê‚ïê‚ïê */
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            92% { opacity: 1; }
            93% { opacity: 0.85; }
            94% { opacity: 1; }
            96% { opacity: 0.92; }
            97% { opacity: 1; }
        }
        
        #mainApp {
            animation: flicker 5s infinite;
            /* RGB Chromatic aberration on all text */
            text-shadow: -0.5px 0 rgba(255, 0, 100, 0.3), 0.5px 0 rgba(0, 255, 255, 0.3);
        }
        
        /* ‚ïê‚ïê‚ïê VHS TRACKING LINES - MORE VISIBLE ‚ïê‚ïê‚ïê */
        .vhs-lines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 2px,
                rgba(0, 240, 208, 0.05) 2px,
                rgba(0, 240, 208, 0.05) 3px
            );
            pointer-events: none;
            z-index: 9996;
            animation: vhs-roll 8s linear infinite;
        }
        
        @keyframes vhs-roll {
            0% { transform: translateY(0); }
            100% { transform: translateY(60px); }
        }
        
        /* ‚ïê‚ïê‚ïê HORIZONTAL LINE NOISE - DISABLED ‚ïê‚ïê‚ïê */
        .hline-noise { display: none; }
        .hline { display: none; }
        
        /* ‚ïê‚ïê‚ïê RAIN EFFECT ‚ïê‚ïê‚ïê */
        .rain-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 9995;
            overflow: hidden;
            opacity: 0.15;
        }
        
        .rain {
            position: absolute;
            width: 1px;
            height: 80px;
            background: linear-gradient(transparent, var(--fg));
            animation: rain-fall linear infinite;
        }
        
        @keyframes rain-fall {
            0% { transform: translateY(-100px); }
            100% { transform: translateY(100vh); }
        }
        
        /* ‚ïê‚ïê‚ïê STATIC NOISE ‚ïê‚ïê‚ïê */
        .static-noise {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0;
            pointer-events: none;
            z-index: 9997;
            mix-blend-mode: overlay;
        }
        
        .static-noise.active {
            animation: static-burst 0.25s steps(5) forwards;
        }
        
        @keyframes static-burst {
            0% { opacity: 0.5; }
            20% { opacity: 0.2; }
            40% { opacity: 0.6; }
            60% { opacity: 0.1; }
            80% { opacity: 0.4; }
            100% { opacity: 0; }
        }
        
        /* ‚ïê‚ïê‚ïê PHOSPHOR GLOW ‚ïê‚ïê‚ïê */
        .window, .task-item, .list-menu-item, .btn {
            transition: box-shadow 0.15s ease-out, text-shadow 0.15s ease-out;
        }
        
        .task-item:active, .list-menu-item:active, .btn:active {
            box-shadow: 0 0 20px var(--fg-dim), inset 0 0 15px rgba(0, 240, 208, 0.1);
            text-shadow: 0 0 10px var(--fg);
        }
        
        .phosphor-trail {
            animation: phosphor-fade 0.5s ease-out forwards;
        }
        
        @keyframes phosphor-fade {
            0% { text-shadow: 0 0 15px var(--fg), 0 0 30px var(--fg), 0 0 45px var(--fg); opacity: 1; }
            100% { text-shadow: 0 0 3px var(--fg); opacity: 0.85; }
        }
        
        /* ‚ïê‚ïê‚ïê BOOT SCREEN ‚ïê‚ïê‚ïê */
        .boot-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            /* RGB chromatic aberration */
            text-shadow: -1px 0 rgba(255, 0, 100, 0.4), 1px 0 rgba(0, 255, 255, 0.4);
        }
        
        /* Heavy scanlines on boot - ABOVE content */
        .boot-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.4) 0px,
                rgba(0, 0, 0, 0.4) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 10010;
        }
        
        /* Interlace + vignette on boot - ABOVE scanlines */
        .boot-screen::after {
            content: '';
            position: absolute;
            top: -5%; left: -5%; right: -5%; bottom: -5%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 240, 208, 0.02) 0px,
                    transparent 1px,
                    transparent 3px
                ),
                radial-gradient(
                    ellipse at center,
                    transparent 0%,
                    transparent 40%,
                    rgba(0, 0, 0, 0.35) 70%,
                    rgba(0, 0, 0, 0.7) 100%
                );
            pointer-events: none;
            z-index: 10011;
            animation: boot-interlace 0.15s steps(2) infinite;
        }
        
        @keyframes boot-interlace {
            0% { background-position: 0 0; }
            100% { background-position: 0 2px; }
        }
        
        .boot-screen.hidden { display: none; }
        
        .boot-screen.power-on { animation: monitor-on 0.6s ease-out forwards; }
        
        @keyframes monitor-on {
            0% { clip-path: inset(50% 0 50% 0); filter: brightness(3) contrast(1.5); }
            30% { clip-path: inset(0 0 0 0); filter: brightness(2) contrast(1.2); }
            100% { clip-path: inset(0 0 0 0); filter: brightness(1) contrast(1); }
        }
        
        .boot-japanese {
            font-size: 14px;
            letter-spacing: 8px;
            margin-bottom: 25px;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 0.5s, text-flicker 0.15s infinite;
            position: relative;
            z-index: 10003;
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent);
        }
        
        @keyframes text-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.92; }
        }
        
        @keyframes fade-in { to { opacity: 1; } }
        
        .boot-eye-container {
            position: relative;
            margin-bottom: 30px;
            opacity: 0;
            animation: fade-in 0.8s ease forwards 0.8s;
            z-index: 10003;
        }
        
        .boot-eye-outer {
            width: 140px;
            height: 140px;
            border: 2px solid var(--fg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 30px var(--fg-dim), 0 0 60px var(--fg-dark), inset 0 0 20px var(--fg-dark);
            animation: eye-pulse 3s ease-in-out infinite;
        }
        
        @keyframes eye-pulse {
            0%, 100% { box-shadow: 0 0 20px var(--fg-dim), 0 0 40px var(--fg-dark), inset 0 0 20px var(--fg-dark); }
            50% { box-shadow: 0 0 40px var(--fg), 0 0 80px var(--fg-dim), inset 0 0 30px var(--fg-dark); }
        }
        
        .boot-eye-inner {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, var(--fg-bright), var(--fg), var(--fg-dim));
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 25px var(--fg);
        }
        
        .boot-eye-pupil {
            position: absolute;
            width: 28px;
            height: 28px;
            background: var(--bg);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .boot-eye-pupil::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--fg-bright);
            border-radius: 50%;
            top: 6px;
            left: 6px;
            box-shadow: 0 0 10px var(--fg-bright);
        }
        
        .boot-scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--fg-bright), transparent);
            top: 0;
            animation: scan 2.5s ease-in-out infinite;
            box-shadow: 0 0 8px var(--fg);
        }
        
        @keyframes scan {
            0%, 100% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .boot-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--fg);
        }
        
        .boot-corner-tl { top: -12px; left: -12px; border-right: none; border-bottom: none; }
        .boot-corner-tr { top: -12px; right: -12px; border-left: none; border-bottom: none; }
        .boot-corner-bl { bottom: -12px; left: -12px; border-right: none; border-top: none; }
        .boot-corner-br { bottom: -12px; right: -12px; border-left: none; border-top: none; }
        
        .boot-title {
            font-size: 28px;
            letter-spacing: 12px;
            margin-bottom: 8px;
            position: relative;
            z-index: 10003;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 1.2s, title-glitch 3s infinite 2s;
            color: var(--fg);
            text-shadow: 0 0 20px var(--fg), 0 0 40px var(--fg-dim);
        }
        
        @keyframes title-glitch {
            0%, 90%, 100% { 
                filter: drop-shadow(0 0 20px var(--fg)) drop-shadow(-1px 0 rgba(255,0,100,0.5)) drop-shadow(1px 0 rgba(0,255,255,0.5));
                transform: translate(0); 
            }
            91% { filter: drop-shadow(-3px 0 var(--accent)) drop-shadow(3px 0 var(--fg-bright)); transform: translate(3px, 0); }
            92% { filter: drop-shadow(3px 0 var(--accent)) drop-shadow(-3px 0 var(--fg-bright)); transform: translate(-3px, 1px); }
            93% { filter: drop-shadow(-2px 0 var(--accent)) drop-shadow(2px 0 var(--fg-bright)); transform: translate(2px, -1px); }
            94% { filter: drop-shadow(0 0 20px var(--fg)); transform: translate(0); }
        }
        
        .boot-subtitle {
            font-size: 10px;
            letter-spacing: 8px;
            color: var(--fg-dim);
            margin-bottom: 20px;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 1.4s, text-flicker 0.2s infinite;
            position: relative;
            z-index: 10003;
        }
        
        .boot-divider {
            width: 180px;
            height: 2px;
            background: 
                repeating-linear-gradient(
                    90deg,
                    var(--fg) 0px,
                    var(--fg) 4px,
                    transparent 4px,
                    transparent 8px
                );
            margin-bottom: 15px;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 1.6s;
            position: relative;
            z-index: 10003;
        }
        
        .boot-text {
            font-size: 10px;
            text-align: left;
            min-height: 80px;
            max-width: 260px;
            line-height: 1.8;
            opacity: 0;
            animation: fade-in 0.3s ease forwards 1.8s;
            position: relative;
            z-index: 10003;
            font-family: 'Share Tech Mono', monospace;
            color: var(--fg);
            text-shadow: 0 0 5px var(--fg-dim);
        }
        
        .boot-progress {
            margin-top: 15px;
            font-size: 10px;
            letter-spacing: 2px;
            position: relative;
            z-index: 10003;
            color: var(--fg-dim);
            text-shadow: 0 0 5px var(--fg-dark);
        }
        
        .boot-status {
            display: flex;
            gap: 18px;
            margin-top: 20px;
            font-size: 8px;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 3.5s;
            position: relative;
            z-index: 10003;
            color: var(--fg-dim);
        }
        
        .boot-status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            animation: text-flicker 0.3s infinite;
        }
        
        .boot-status-dot {
            width: 6px;
            height: 6px;
            background: var(--fg);
            border-radius: 50%;
            animation: blink 1s steps(2) infinite;
            box-shadow: 0 0 8px var(--fg);
        }
        
        .boot-status-dot.warning { 
            background: var(--warning); 
            box-shadow: 0 0 8px var(--warning);
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        .boot-continue {
            margin-top: 20px;
            font-size: 9px;
            letter-spacing: 3px;
            opacity: 0;
            position: relative;
            z-index: 10003;
            color: var(--fg);
            text-shadow: 0 0 8px var(--fg);
        }
        
        .boot-continue.visible {
            opacity: 1;
            animation: blink 0.8s steps(2) infinite;
        }
        
        .boot-corp {
            position: absolute;
            bottom: 40px;
            font-size: 8px;
            letter-spacing: 4px;
            text-align: center;
            opacity: 0;
            animation: fade-in 0.5s ease forwards 3s, text-flicker 0.25s infinite 3s;
            z-index: 10003;
            color: var(--fg-dim);
        }
        
        .boot-corp .accent { 
            color: var(--accent);
            text-shadow: 0 0 8px var(--accent);
        }
        
        .cursor {
            display: inline-block;
            background: var(--fg);
            width: 8px;
            height: 12px;
            animation: cursor-blink 0.5s steps(2) infinite;
            vertical-align: middle;
            margin-left: 2px;
            box-shadow: 0 0 10px var(--fg);
        }
        
        @keyframes cursor-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* ‚ïê‚ïê‚ïê BOOT SCREEN OVERLAY ‚ïê‚ïê‚ïê */
        .boot-noise {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0.06;
            pointer-events: none;
            z-index: 10004;
            mix-blend-mode: overlay;
            animation: boot-noise 0.15s steps(4) infinite;
        }
        
        @keyframes boot-noise {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-1%, 1%); }
            50% { transform: translate(1%, -1%); }
            75% { transform: translate(-1%, -1%); }
        }
        
        /* ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê */
        .top-bar {
            position: fixed;
            top: 18px;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(0,240,208,0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--fg-dim);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .top-bar-jp {
            font-size: 16px;
            color: #00FFFF;
            text-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF;
        }
        
        .top-bar-title {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 4px;
            text-shadow: 0 0 15px var(--fg-dim);
            animation: title-glow 3s ease-in-out infinite;
        }
        
        @keyframes title-glow {
            0%, 100% { text-shadow: 0 0 10px var(--fg-dim); }
            50% { text-shadow: 0 0 20px var(--fg), 0 0 30px var(--fg-dim); }
        }
        
        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 11px;
            color: var(--fg-dim);
        }
        
        .top-bar-right span {
            text-shadow: 0 0 5px var(--fg-dark);
        }
        
        /* ‚ïê‚ïê‚ïê XP SECTION ‚ïê‚ïê‚ïê */
        .xp-section {
            position: fixed;
            top: 54px;
            left: 0;
            right: 0;
            padding: 8px 15px;
            background: var(--bg-light);
            border-bottom: 1px solid var(--fg-dark);
            z-index: 100;
        }
        
        .xp-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .xp-level {
            color: var(--fg-bright);
            font-weight: bold;
            text-shadow: 0 0 10px var(--fg-dim);
        }
        
        .xp-bar {
            flex: 1;
            height: 10px;
            border: 1px solid var(--fg-dim);
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }
        
        .xp-bar::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 4px,
                rgba(0, 240, 208, 0.1) 4px,
                rgba(0, 240, 208, 0.1) 5px
            );
        }
        
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--fg-dim), var(--fg), var(--fg-bright));
            box-shadow: 0 0 15px var(--fg-dim), inset 0 0 5px var(--fg);
            transition: width 0.5s ease;
            position: relative;
        }
        
        .xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, var(--fg-bright));
            animation: xp-shine 2s ease-in-out infinite;
        }
        
        @keyframes xp-shine {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .xp-text {
            font-size: 10px;
            color: var(--fg-dim);
            min-width: 80px;
            text-align: right;
        }
        
        /* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
        .content {
            padding: 15px;
            padding-bottom: calc(85px + var(--safe-bottom));
            min-height: calc(100vh - 150px);
        }
        
        /* ‚ïê‚ïê‚ïê WINDOW - BLADE RUNNER STYLE ‚ïê‚ïê‚ïê */
        .window {
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg) 100%);
            border: 2px solid var(--fg);
            margin-bottom: 15px;
            box-shadow: 
                0 0 20px rgba(0, 240, 208, 0.15),
                inset 0 1px 0 rgba(0, 240, 208, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .window::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--fg-bright), transparent);
            z-index: 2;
        }
        
        /* Dithering overlay for 80s CRT look */
        .window::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.08) 1px,
                rgba(0, 0, 0, 0.08) 2px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .window-title-bar {
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    transparent 1px,
                    rgba(0, 0, 0, 0.15) 1px,
                    rgba(0, 0, 0, 0.15) 2px
                ),
                linear-gradient(90deg, var(--fg) 0%, var(--fg-dim) 50%, var(--fg) 100%);
            color: var(--bg);
            padding: 5px 12px;
            display: flex;
            align-items: center;
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 2px;
            gap: 10px;
            position: relative;
            z-index: 3;
        }
        
        .window-close {
            width: 12px;
            height: 12px;
            border: 2px solid var(--bg);
            background: transparent;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .window-title-stripes {
            flex: 1;
            height: 10px;
            background: repeating-linear-gradient(
                0deg,
                var(--bg) 0px,
                var(--bg) 2px,
                transparent 2px,
                transparent 4px
            );
        }
        
        .window-content {
            padding: 15px;
            position: relative;
            z-index: 2;
        }
        
        /* ‚ïê‚ïê‚ïê MAC ICONS (SVG) ‚ïê‚ïê‚ïê */
        .mac-icon {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 3px var(--fg-dim));
        }
        
        .mac-icon svg { width: 100%; height: 100%; }
        .mac-icon-sm { width: 20px; height: 20px; }
        .mac-icon-lg { width: 44px; height: 44px; }
        
        /* ‚ïê‚ïê‚ïê DITHER FRAME ‚ïê‚ïê‚ïê */
        .dither-frame {
            border: 2px solid var(--fg);
            padding: 3px;
            background: var(--bg);
            box-shadow: 0 0 10px var(--fg-dark);
        }
        
        .dither-frame-inner {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-light), var(--bg));
        }
        
        .dither-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent 0px, transparent 2px, rgba(0,0,0,0.25) 2px, rgba(0,0,0,0.25) 4px),
                repeating-linear-gradient(90deg, transparent 0px, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px);
            pointer-events: none;
        }
        
        /* ‚ïê‚ïê‚ïê DOSSIER GRID ‚ïê‚ïê‚ïê */
        .dossier-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 15px;
            font-size: 12px;
        }
        
        .dossier-label {
            color: var(--fg-dim);
            letter-spacing: 1px;
        }
        
        .dossier-value {
            color: var(--fg-bright);
            text-shadow: 0 0 8px var(--fg-dim);
        }
        
        /* ‚ïê‚ïê‚ïê STATS ROW ‚ïê‚ïê‚ïê */
        .stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-box {
            flex: 1;
            border: 1px solid var(--fg-dim);
            padding: 12px 8px;
            text-align: center;
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--fg-dim), transparent);
        }
        
        .stat-value {
            font-size: 22px;
            color: var(--fg-bright);
            text-shadow: 0 0 15px var(--fg-dim);
        }
        
        .stat-label {
            font-size: 9px;
            color: var(--fg-dim);
            margin-top: 5px;
            letter-spacing: 2px;
        }
        
        /* ‚ïê‚ïê‚ïê TASK ITEM ‚ïê‚ïê‚ïê */
        .task-item {
            border: 1px solid var(--fg-dark);
            margin-bottom: 12px;
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg) 100%);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        /* Left accent bar */
        .task-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: var(--fg);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }
        
        /* CRT scanline overlay */
        .task-item::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.06) 1px,
                rgba(0, 0, 0, 0.06) 2px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .task-item:active::before {
            opacity: 1;
        }
        
        .task-item.completed { opacity: 0.4; }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px dashed var(--fg-dark);
            font-size: 10px;
        }
        
        .task-id { 
            color: var(--fg-dim); 
            letter-spacing: 2px;
            font-family: monospace;
        }
        
        .task-status {
            padding: 3px 10px;
            border: 1px solid;
            font-size: 9px;
            letter-spacing: 1px;
        }
        
        .task-status.active { border-color: var(--fg); color: var(--fg); }
        .task-status.overdue { border-color: var(--warning); color: var(--warning); }
        .task-status.urgent { background: var(--danger); border-color: var(--danger); color: var(--bg); }
        .task-status.done { border-color: var(--fg-dim); color: var(--fg-dim); }
        
        .task-body {
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        
        .task-icon { flex-shrink: 0; color: var(--fg-dim); }
        .task-info { flex: 1; min-width: 0; }
        
        .task-title {
            font-size: 13px;
            color: var(--fg-bright);
            margin-bottom: 8px;
            word-break: break-word;
            text-shadow: 0 0 5px var(--fg-dark);
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
        }
        
        .task-meta {
            font-size: 10px;
            color: var(--fg-dim);
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
        }
        
        .task-xp { 
            color: var(--warning); 
            text-shadow: 0 0 8px rgba(255, 184, 0, 0.5);
        }
        
        /* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: 2px solid var(--fg);
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg) 100%);
            color: var(--fg);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            letter-spacing: 2px;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 208, 0.2), transparent);
            transition: left 0.3s;
        }
        
        .btn:active::before {
            left: 100%;
        }
        
        .btn:active {
            background: var(--fg);
            color: var(--bg);
            box-shadow: 0 0 25px var(--fg-dim);
        }
        
        .btn-block { width: 100%; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:active { background: var(--danger); }
        
        /* ‚ïê‚ïê‚ïê FORMS ‚ïê‚ïê‚ïê */
        .form-group { margin-bottom: 18px; }
        
        .form-label {
            display: block;
            font-size: 10px;
            color: var(--fg-dim);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--fg-dim);
            background: var(--bg);
            color: var(--fg);
            font-family: inherit;
            font-size: 13px;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--fg);
            box-shadow: 0 0 20px var(--fg-dark), inset 0 0 10px rgba(0, 240, 208, 0.05);
        }
        
        .input::placeholder { color: var(--fg-dark); }
        .input[type="date"] { color-scheme: dark; }
        
        .select-row {
            display: flex;
            gap: 8px;
        }
        
        .select-btn {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid var(--fg-dark);
            background: var(--bg);
            color: var(--fg-dim);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }
        
        .select-btn.active {
            border-color: var(--fg);
            color: var(--fg);
            background: var(--fg-dark);
            box-shadow: 0 0 10px var(--fg-dark);
        }
        
        /* ‚ïê‚ïê‚ïê STICKERS ‚ïê‚ïê‚ïê */
        .stickers-container {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 98;
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: auto;
        }
        
        .sticker {
            width: 45px;
            height: 45px;
            background: #FFE135;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transform: rotate(5deg);
            box-shadow: 
                2px 2px 5px rgba(0,0,0,0.4),
                inset 0 -2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .sticker::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            border-radius: 3px 3px 0 0;
        }
        
        .sticker:nth-child(2) { transform: rotate(-3deg); }
        .sticker:nth-child(3) { transform: rotate(8deg); }
        .sticker:nth-child(4) { transform: rotate(-5deg); }
        
        .sticker:hover {
            transform: rotate(0deg) scale(1.15);
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        .sticker.pink { background: #FF69B4; }
        .sticker.blue { background: #87CEEB; }
        .sticker.green { background: #90EE90; }
        .sticker.orange { background: #FFA500; }
        .sticker.purple { background: #DDA0DD; }
        
        .sticker-add {
            background: rgba(255,255,255,0.1);
            border: 2px dashed var(--fg-dim);
            color: var(--fg-dim);
            font-size: 18px;
        }
        
        .sticker-add:hover {
            border-color: var(--fg);
            color: var(--fg);
        }
        
        .stickers-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .sticker-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border: 1px solid var(--fg-dark);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .sticker-item:hover:not(.locked) {
            border-color: var(--fg);
            background: rgba(0, 240, 208, 0.05);
        }
        
        .sticker-item.active {
            border-color: var(--fg);
            background: rgba(0, 240, 208, 0.1);
        }
        
        .sticker-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .sticker-preview {
            width: 36px;
            height: 36px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #FFE135;
            flex-shrink: 0;
        }
        
        .sticker-preview.pink { background: #FF69B4; }
        .sticker-preview.blue { background: #87CEEB; }
        .sticker-preview.green { background: #90EE90; }
        .sticker-preview.orange { background: #FFA500; }
        .sticker-preview.purple { background: #DDA0DD; }
        
        .sticker-info { flex: 1; }
        .sticker-name { font-size: 11px; color: var(--fg); margin-bottom: 2px; }
        .sticker-desc { font-size: 9px; color: var(--fg-dim); }
        .sticker-active { color: var(--fg); font-size: 14px; }
        
        /* ‚ïê‚ïê‚ïê RPG STATS ‚ïê‚ïê‚ïê */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            border: 1px solid var(--fg-dark);
            padding: 10px 5px;
            text-align: center;
            background: rgba(0, 240, 208, 0.03);
        }
        
        .stat-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--fg-bright);
        }
        
        .stat-name {
            font-size: 7px;
            color: var(--fg-dim);
            letter-spacing: 1px;
            margin-top: 4px;
        }
        
        /* ‚ïê‚ïê‚ïê QUEST PANELS ‚ïê‚ïê‚ïê */
        .quest-panel {
            border: 2px solid var(--warning);
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .quest-panel.weekly {
            border-color: #00BFFF;
        }
        
        .quest-panel.epic {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, transparent 100%);
        }
        
        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .quest-type {
            font-size: 8px;
            padding: 2px 6px;
            background: var(--warning);
            color: var(--bg);
            letter-spacing: 1px;
        }
        
        .quest-panel.weekly .quest-type { background: #00BFFF; }
        .quest-panel.epic .quest-type { background: #FFD700; }
        
        .quest-reward {
            font-size: 10px;
            color: var(--warning);
        }
        
        .quest-name {
            font-size: 12px;
            color: var(--fg);
            margin-bottom: 4px;
        }
        
        .quest-desc {
            font-size: 9px;
            color: var(--fg-dim);
            margin-bottom: 8px;
        }
        
        .quest-progress-bar {
            height: 6px;
            background: var(--fg-dark);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .quest-progress-fill {
            height: 100%;
            background: var(--fg);
            transition: width 0.3s;
        }
        
        .quest-panel.weekly .quest-progress-fill { background: #00BFFF; }
        .quest-panel.epic .quest-progress-fill { background: #FFD700; }
        
        .quest-progress-text {
            font-size: 9px;
            color: var(--fg-dim);
            margin-top: 4px;
            text-align: right;
        }
        
        /* ‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê */
        .leaderboard {
            border: 1px solid var(--fg-dim);
        }
        
        .leaderboard-header {
            background: var(--fg);
            color: var(--bg);
            padding: 8px 12px;
            font-size: 10px;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
        }
        
        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--fg-dark);
            gap: 10px;
        }
        
        .leaderboard-row:last-child { border-bottom: none; }
        
        .leaderboard-row.you {
            background: rgba(0, 240, 208, 0.1);
            border-color: var(--fg);
        }
        
        .lb-rank {
            width: 24px;
            font-size: 12px;
            font-weight: bold;
            color: var(--fg-dim);
        }
        
        .lb-rank.gold { color: #FFD700; }
        .lb-rank.silver { color: #C0C0C0; }
        .lb-rank.bronze { color: #CD7F32; }
        
        .lb-avatar {
            font-size: 18px;
        }
        
        .lb-name {
            flex: 1;
            font-size: 11px;
            color: var(--fg);
        }
        
        .lb-xp {
            font-size: 10px;
            color: var(--fg-dim);
        }
        
        .lb-level {
            font-size: 9px;
            color: var(--warning);
            background: rgba(255, 184, 0, 0.2);
            padding: 2px 6px;
        }
        
        /* ‚ïê‚ïê‚ïê OCTALYSIS ENHANCEMENTS ‚ïê‚ïê‚ïê */
        
        /* Avatar Selector */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .avatar-item {
            border: 2px solid var(--fg-dark);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .avatar-item:hover { border-color: var(--fg-dim); }
        .avatar-item.selected { border-color: var(--fg); background: rgba(0, 240, 208, 0.1); }
        .avatar-item.locked { opacity: 0.3; cursor: not-allowed; }
        .avatar-item .avatar-emoji { font-size: 28px; }
        .avatar-item .avatar-name { font-size: 8px; margin-top: 5px; color: var(--fg-dim); }
        
        /* Title Selector */
        .title-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .title-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid var(--fg-dark);
            cursor: pointer;
        }
        
        .title-item:hover { border-color: var(--fg-dim); }
        .title-item.selected { border-color: var(--warning); background: rgba(255, 184, 0, 0.1); }
        .title-item.locked { opacity: 0.3; cursor: not-allowed; }
        
        /* Custom Quest */
        .custom-quest {
            border: 2px dashed var(--cyan);
            padding: 12px;
            margin-bottom: 12px;
            background: rgba(0, 255, 255, 0.05);
        }
        
        .custom-quest .quest-header { border-color: var(--cyan); }
        .custom-quest .quest-type { background: var(--cyan); }
        
        /* Gratitude Journal */
        .gratitude-entry {
            border-left: 3px solid var(--warning);
            padding: 10px 12px;
            margin-bottom: 10px;
            background: rgba(255, 184, 0, 0.05);
        }
        
        .gratitude-date {
            font-size: 9px;
            color: var(--fg-dim);
            margin-bottom: 5px;
        }
        
        .gratitude-text {
            font-size: 11px;
            color: var(--fg);
            font-style: italic;
        }
        
        /* Affirmation Banner */
        .affirmation-banner {
            background: linear-gradient(135deg, rgba(0, 240, 208, 0.1) 0%, rgba(255, 184, 0, 0.1) 100%);
            border: 1px solid var(--fg-dim);
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .affirmation-text {
            font-size: 12px;
            color: var(--fg);
            font-style: italic;
            margin-bottom: 8px;
        }
        
        .affirmation-dismiss {
            font-size: 9px;
            color: var(--fg-dim);
            cursor: pointer;
        }
        
        /* Mystery Box */
        .mystery-box {
            border: 2px solid #FFD700;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mystery-box:hover {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            transform: scale(1.02);
        }
        
        .mystery-box.opened {
            cursor: default;
            opacity: 0.6;
        }
        
        .mystery-icon {
            font-size: 48px;
            animation: mystery-float 2s ease-in-out infinite;
        }
        
        @keyframes mystery-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Milestone Celebration */
        .milestone-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .milestone-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .milestone-content {
            text-align: center;
            animation: milestone-appear 0.5s ease-out;
        }
        
        @keyframes milestone-appear {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .milestone-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: milestone-bounce 0.5s ease-out infinite alternate;
        }
        
        @keyframes milestone-bounce {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .milestone-message {
            font-size: 18px;
            color: var(--warning);
            text-shadow: 0 0 20px var(--warning);
            margin-bottom: 10px;
        }
        
        .milestone-reward {
            font-size: 14px;
            color: var(--fg);
        }
        
        /* Lucky Bonus indicator */
        .lucky-bonus {
            color: #FFD700;
            animation: lucky-pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes lucky-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .select-btn[data-priority="high"].active { border-color: var(--danger); color: var(--danger); }
        .select-btn[data-priority="medium"].active { border-color: var(--warning); color: var(--warning); }
        
        /* ‚ïê‚ïê‚ïê MARQUEE ‚ïê‚ïê‚ïê */
        .marquee-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 18px;
            background: var(--bg);
            border-bottom: 1px solid var(--fg-dark);
            overflow: hidden;
            z-index: 102;
            display: flex;
            align-items: center;
        }
        
        .marquee-content {
            display: flex;
            animation: marquee 25s linear infinite;
            white-space: nowrap;
            font-size: 9px;
            color: var(--warning);
            letter-spacing: 2px;
        }
        
        .marquee-content span {
            padding: 0 50px;
        }
        
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* ‚ïê‚ïê‚ïê STATUS BAR ‚ïê‚ïê‚ïê */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: var(--fg);
            color: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            padding-bottom: var(--safe-bottom);
            font-size: 9px;
            font-weight: bold;
            z-index: 102;
            letter-spacing: 1px;
        }
        
        /* ‚ïê‚ïê‚ïê STATS ROW ‚ïê‚ïê‚ïê */
        .stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-box {
            flex: 1;
            border: 1px solid var(--fg-dim);
            padding: 12px 8px;
            text-align: center;
            background: rgba(0, 240, 208, 0.03);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--fg-bright);
            text-shadow: 0 0 10px var(--fg);
        }
        
        .stat-label {
            font-size: 9px;
            color: var(--fg-dim);
            letter-spacing: 2px;
            margin-top: 4px;
        }
        
        .stat-box.danger { border-color: var(--danger); }
        .stat-box.danger .stat-value { color: var(--danger); text-shadow: 0 0 10px var(--danger); }
        
        /* ‚ïê‚ïê‚ïê INLINE CHECKBOX ‚ïê‚ïê‚ïê */
        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--fg);
            background: transparent;
            color: var(--fg);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }
        
        .task-checkbox:hover {
            background: rgba(0, 240, 208, 0.2);
            box-shadow: 0 0 10px var(--fg);
        }
        
        .task-checkbox.checked {
            background: var(--fg);
            color: var(--bg);
        }
        
        /* ‚ïê‚ïê‚ïê HABITS CYAN STYLE ‚ïê‚ïê‚ïê */
        .habits-window {
            border-color: #00FFFF !important;
        }
        
        .habits-window .window-title-bar {
            border-color: #00FFFF !important;
            background: #00FFFF;
        }
        
        .habits-window .window-title-bar span {
            color: var(--bg);
        }
        
        .habits-window .window-title-bar .window-close {
            border-color: var(--bg);
        }
        
        .habits-window .window-title-bar .window-title-stripes::before,
        .habits-window .window-title-bar .window-title-stripes::after {
            background: var(--bg);
        }
        
        .habits-window .habit-item {
            border-color: #00FFFF;
        }
        
        .habits-window .habit-check {
            border-color: #00FFFF;
            color: #00FFFF;
        }
        
        .habits-window .habit-check.done {
            background: #00FFFF;
            color: var(--bg);
        }
        
        .habits-window .habit-name {
            color: #00FFFF;
        }
        
        /* ‚ïê‚ïê‚ïê NAV BAR ‚ïê‚ïê‚ïê */
        .nav-bar {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            left: 0;
            right: 0;
            background: linear-gradient(0deg, var(--bg) 0%, var(--bg-light) 100%);
            border-top: 2px solid var(--fg);
            border-bottom: 2px solid var(--fg);
            display: flex;
            z-index: 101;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            color: var(--fg-dim);
            cursor: pointer;
            border-right: 1px solid var(--fg-dark);
            transition: all 0.15s;
            position: relative;
        }
        
        .nav-item:last-child { border-right: none; }
        
        .nav-item.active {
            color: var(--fg);
            background: rgba(0, 240, 208, 0.1);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--fg);
            box-shadow: 0 0 10px var(--fg);
        }
        
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-label { font-size: 9px; letter-spacing: 2px; }
        
        /* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            width: 100%;
            max-width: 380px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modal-in 0.3s ease-out;
        }
        
        @keyframes modal-in {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        /* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(60px);
            background: var(--bg);
            border: 2px solid var(--fg);
            color: var(--fg);
            padding: 14px 28px;
            font-size: 11px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 0 30px var(--fg-dim);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* ‚ïê‚ïê‚ïê LEVEL UP ‚ïê‚ïê‚ïê */
        .levelup-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .levelup-overlay.active { display: flex; }
        
        .levelup-ascii {
            font-size: 9px;
            white-space: pre;
            margin-bottom: 25px;
            color: var(--fg);
            text-shadow: 0 0 25px var(--fg);
            animation: levelup-pulse 0.5s infinite alternate;
        }
        
        @keyframes levelup-pulse {
            0% { opacity: 0.7; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1.02); }
        }
        
        .levelup-number {
            font-size: 56px;
            color: var(--fg-bright);
            text-shadow: 0 0 40px var(--fg), 0 0 80px var(--fg-dim);
            animation: levelup-glow 1s ease-in-out infinite alternate;
        }
        
        @keyframes levelup-glow {
            0% { text-shadow: 0 0 30px var(--fg); }
            100% { text-shadow: 0 0 60px var(--fg), 0 0 100px var(--fg-dim); }
        }
        
        .levelup-rank {
            font-size: 16px;
            color: var(--accent);
            margin-top: 15px;
            letter-spacing: 4px;
            text-shadow: 0 0 15px var(--accent);
        }
        
        .levelup-text {
            font-size: 10px;
            color: var(--fg-dim);
            margin-top: 30px;
            animation: cursor-blink 1s step-end infinite;
        }
        
        /* ‚ïê‚ïê‚ïê ACHIEVEMENT ‚ïê‚ïê‚ïê */
        .achievement-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            padding: 20px;
        }
        
        .achievement-overlay.active {
            display: flex;
            animation: ach-appear 0.5s ease-out;
        }
        
        @keyframes ach-appear {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .achievement-icon {
            font-size: 64px;
            color: var(--warning);
            text-shadow: 0 0 40px var(--warning), 0 0 80px var(--warning);
            margin-bottom: 25px;
            animation: ach-glow 1s infinite alternate;
        }
        
        @keyframes ach-glow {
            0% { text-shadow: 0 0 30px var(--warning); transform: scale(1); }
            100% { text-shadow: 0 0 60px var(--warning), 0 0 100px var(--warning); transform: scale(1.1); }
        }
        
        .achievement-title {
            font-size: 11px;
            color: var(--warning);
            letter-spacing: 4px;
            margin-bottom: 12px;
        }
        
        .achievement-name {
            font-size: 18px;
            color: var(--fg-bright);
            text-shadow: 0 0 20px var(--fg);
            margin-bottom: 12px;
        }
        
        .achievement-desc {
            font-size: 11px;
            color: var(--fg-dim);
            margin-bottom: 30px;
        }
        
        .achievement-continue {
            font-size: 10px;
            color: var(--fg-dim);
            animation: cursor-blink 1s step-end infinite;
        }
        
        /* ‚ïê‚ïê‚ïê BOSS MODE ‚ïê‚ïê‚ïê */
        .boss-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            padding: 20px;
        }
        
        .boss-overlay.active {
            display: flex;
            animation: boss-appear 0.5s ease-out;
        }
        
        @keyframes boss-appear {
            0% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .boss-title {
            font-size: 20px;
            color: var(--accent);
            text-shadow: 0 0 30px var(--accent), 0 0 60px var(--accent);
            margin-bottom: 8px;
            letter-spacing: 6px;
            animation: boss-pulse 1s infinite;
        }
        
        @keyframes boss-pulse {
            0%, 100% { text-shadow: 0 0 30px var(--accent); }
            50% { text-shadow: 0 0 60px var(--accent), 0 0 100px var(--accent); }
        }
        
        .boss-subtitle {
            font-size: 10px;
            color: var(--fg-dim);
            letter-spacing: 4px;
            margin-bottom: 25px;
        }
        
        .boss-task {
            font-size: 14px;
            color: var(--fg-bright);
            text-align: center;
            max-width: 300px;
            margin-bottom: 30px;
            line-height: 1.6;
            padding: 15px;
            border: 1px solid var(--fg-dim);
        }
        
        .boss-timer {
            font-size: 48px;
            color: var(--fg);
            text-shadow: 0 0 30px var(--fg);
            margin-bottom: 15px;
            font-variant-numeric: tabular-nums;
        }
        
        .boss-timer.warning {
            color: var(--warning);
            text-shadow: 0 0 30px var(--warning);
            animation: boss-pulse 0.5s infinite;
        }
        
        .boss-timer.danger {
            color: var(--accent);
            text-shadow: 0 0 30px var(--accent);
            animation: boss-pulse 0.3s infinite;
        }
        
        .boss-progress {
            width: 280px;
            height: 12px;
            border: 1px solid var(--fg-dim);
            margin-bottom: 15px;
            padding: 2px;
        }
        
        .boss-progress-fill {
            height: 100%;
            background: var(--fg);
            transition: width 1s linear;
        }
        
        .boss-progress-fill.warning { background: var(--warning); }
        .boss-progress-fill.danger { background: var(--accent); }
        
        .boss-xp-bonus {
            font-size: 11px;
            color: var(--warning);
            margin-bottom: 30px;
            animation: blink 1s step-end infinite;
        }
        
        .boss-buttons {
            display: flex;
            gap: 20px;
        }
        
        .boss-btn {
            font-family: inherit;
            font-size: 12px;
            padding: 14px 24px;
            background: transparent;
            color: var(--fg);
            border: 2px solid var(--fg);
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 2px;
        }
        
        .boss-btn:active {
            background: var(--fg);
            color: var(--bg);
        }
        
        .boss-btn.fail {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .boss-btn.fail:active {
            background: var(--accent);
            color: var(--bg);
        }
        
        /* ‚ïê‚ïê‚ïê TAGS ‚ïê‚ïê‚ïê */
        .tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .tag {
            font-size: 9px;
            padding: 4px 8px;
            border: 1px solid var(--fg-dim);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tag.selected {
            background: var(--fg);
            color: var(--bg);
        }
        
        .tag-inline {
            font-size: 8px;
            margin-left: 6px;
            opacity: 0.8;
        }
        
        /* ‚ïê‚ïê‚ïê SUBTASKS ‚ïê‚ïê‚ïê */
        .subtasks-list {
            margin-top: 10px;
            padding-left: 10px;
            border-left: 2px solid var(--fg-dark);
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 10px;
        }
        
        .subtask-checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid var(--fg-dim);
            background: transparent;
            color: var(--fg);
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subtask-text { flex: 1; color: var(--fg-dim); }
        .subtask-text.done { text-decoration: line-through; opacity: 0.5; }
        
        .subtask-del {
            color: var(--accent);
            cursor: pointer;
            font-size: 9px;
        }
        
        .add-subtask-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .add-subtask-row input {
            flex: 1;
            font-family: inherit;
            font-size: 10px;
            padding: 6px;
            background: var(--bg);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
        }
        
        .add-subtask-row button {
            font-family: inherit;
            font-size: 10px;
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--fg);
            color: var(--fg);
            cursor: pointer;
        }
        
        /* ‚ïê‚ïê‚ïê HABITS ‚ïê‚ïê‚ïê */
        .habit-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--fg-dark);
            margin-bottom: 8px;
        }
        
        .habit-check {
            width: 32px;
            height: 32px;
            border: 2px solid var(--fg-dim);
            background: transparent;
            color: var(--fg);
            font-size: 16px;
            cursor: pointer;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .habit-check.done {
            background: var(--fg);
            color: var(--bg);
        }
        
        .habit-content { flex: 1; }
        .habit-name { font-size: 12px; margin-bottom: 4px; }
        .habit-meta { font-size: 9px; color: var(--fg-dim); }
        .habit-streak { color: var(--warning); }
        
        /* ‚ïê‚ïê‚ïê DAILY MISSION ‚ïê‚ïê‚ïê */
        .mission-box {
            border: 2px solid var(--accent);
            padding: 12px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .mission-box::before {
            content: '‚óÜ DAILY MISSION ‚óÜ';
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--bg);
            padding: 0 8px;
            font-size: 9px;
            color: var(--accent);
            letter-spacing: 2px;
        }
        
        .mission-name { font-size: 12px; color: var(--accent); margin-bottom: 4px; }
        .mission-desc { font-size: 10px; color: var(--fg-dim); margin-bottom: 8px; }
        .mission-progress { font-size: 9px; color: var(--fg); }
        .mission-reward { font-size: 10px; color: var(--warning); }
        
        /* ‚ïê‚ïê‚ïê LIST MENU ‚ïê‚ïê‚ïê */
        .list-menu { border: 1px solid var(--fg-dim); }
        
        .list-menu-item {
            display: flex;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid var(--fg-dark);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .list-menu-item:last-child { border-bottom: none; }
        .list-menu-item:active { background: var(--fg-dark); }
        
        .list-menu-icon { width: 32px; margin-right: 14px; }
        .list-menu-content { flex: 1; }
        .list-menu-title { font-size: 12px; }
        .list-menu-subtitle { font-size: 10px; color: var(--fg-dim); margin-top: 4px; }
        .list-menu-arrow { color: var(--fg-dim); font-size: 14px; }
        
        /* ‚ïê‚ïê‚ïê THEME SELECTOR ‚ïê‚ïê‚ïê */
        .theme-selector { display: flex; gap: 12px; margin-top: 12px; }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--fg);
            background: var(--bg);
            cursor: pointer;
            position: relative;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .theme-btn:active {
            transform: scale(0.95);
        }
        
        .theme-btn.active {
            box-shadow: 0 0 20px currentColor;
        }
        
        .theme-btn.active::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #000;
            text-shadow: 0 0 5px #fff;
        }
        
        .theme-btn-green { background: #00E5C4; }
        .theme-btn-purple { background: #B388FF; }
        .theme-btn-amber { background: #FF9100; }
        
        /* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--fg-dim);
        }
        
        .empty-icon { margin-bottom: 20px; opacity: 0.5; }
        .empty-title { font-size: 14px; color: var(--fg); margin-bottom: 10px; }
        .empty-text { font-size: 11px; }
        
        /* ‚ïê‚ïê‚ïê SCROLLBAR ‚ïê‚ïê‚ïê */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { 
            background: var(--fg-dim); 
            border: 1px solid var(--fg);
            box-shadow: 0 0 5px var(--fg-dim);
        }
    </style>
</head>
<body data-theme="green">
    <!-- VHS TRACKING LINES -->
    <div class="vhs-lines"></div>
    
    <!-- RAIN EFFECT -->
    <div class="rain-container" id="rainContainer"></div>
    
    <!-- STATIC NOISE -->
    <div class="static-noise" id="staticNoise"></div>
    
    <!-- HORIZONTAL NOISE LINES -->
    <div class="hline-noise" id="hlineNoise"></div>
    
    <!-- BOOT SCREEN -->
    <div class="boot-screen" id="bootScreen">
        <!-- Boot noise overlay -->
        <div class="boot-noise"></div>
        
        <div class="boot-japanese">Ë≠¶ÂØü Á´ØÊú´</div>
        
        <div class="boot-eye-container">
            <div class="boot-eye-outer">
                <div class="boot-scan-line"></div>
                <div class="boot-eye-inner">
                    <div class="boot-eye-pupil"></div>
                </div>
                <div class="boot-corner boot-corner-tl"></div>
                <div class="boot-corner boot-corner-tr"></div>
                <div class="boot-corner boot-corner-bl"></div>
                <div class="boot-corner boot-corner-br"></div>
            </div>
        </div>
        
        <div class="boot-title">NEXUS</div>
        <div class="boot-subtitle">T E R M I N A L</div>
        <div class="boot-divider"></div>
        
        <div class="boot-text" id="bootText"></div>
        <div class="boot-progress" id="bootProgress"></div>
        
        <div class="boot-status">
            <div class="boot-status-item"><div class="boot-status-dot"></div><span>ONLINE</span></div>
            <div class="boot-status-item"><div class="boot-status-dot warning"></div><span>V-K TEST</span></div>
            <div class="boot-status-item"><div class="boot-status-dot"></div><span>READY</span></div>
        </div>
        
        <div class="boot-continue" id="bootContinue">[ PRESS TO ACCESS ]</div>
        
        <div class="boot-corp">
            <div>TYRELL CORPORATION</div>
            <div class="accent">"MORE HUMAN THAN HUMAN"</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <!-- STICKERS -->
        <div class="stickers-container" id="stickersContainer"></div>
        
        <!-- MARQUEE -->
        <div class="marquee-bar">
            <div class="marquee-content">
                <span>‚òÖ LEVEL UP YOUR LIFE ‚òÖ COMPLETE TASKS TO EARN XP ‚òÖ WAKE UP NEO... ‚òÖ THE MATRIX HAS YOU ‚òÖ FOLLOW THE WHITE RABBIT ‚òÖ REPLICANTS DETECTED ‚òÖ VOIGHT-KAMPFF TEST REQUIRED ‚òÖ</span>
                <span>‚òÖ LEVEL UP YOUR LIFE ‚òÖ COMPLETE TASKS TO EARN XP ‚òÖ WAKE UP NEO... ‚òÖ THE MATRIX HAS YOU ‚òÖ FOLLOW THE WHITE RABBIT ‚òÖ REPLICANTS DETECTED ‚òÖ VOIGHT-KAMPFF TEST REQUIRED ‚òÖ</span>
            </div>
        </div>
        
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="top-bar-left">
                <span class="top-bar-jp">Ë≠¶ÂØü</span>
                <span class="top-bar-title">NEXUS</span>
            </div>
            <div class="top-bar-right">
                <span id="dateDisplay">--/--/----</span>
                <span id="timeDisplay">--:--</span>
            </div>
        </div>
        
        <!-- XP SECTION -->
        <div class="xp-section">
            <div class="xp-row">
                <span class="xp-level">LV.<span id="levelNum">01</span></span>
                <div class="xp-bar">
                    <div class="xp-bar-fill" id="xpBarFill" style="width: 0%"></div>
                </div>
                <span class="xp-text" id="xpText">0/100 XP</span>
            </div>
        </div>
        
        <!-- CONTENT -->
        <main class="content" id="mainContent" style="padding-top: 80px; padding-bottom: 78px;"></main>
        
        <!-- STATUS BAR -->
        <div class="status-bar">
            <span id="statusLeft">READY</span>
            <span id="statusRight">TASKS: 0</span>
        </div>
        
        <!-- NAV BAR -->
        <nav class="nav-bar">
            <div class="nav-item active" onclick="App.go('tasks')" data-tab="tasks">
                <span class="nav-icon">‚ñ§</span>
                <span class="nav-label">Tasks</span>
            </div>
            <div class="nav-item" onclick="App.go('plan')" data-tab="plan">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Plan</span>
            </div>
            <div class="nav-item" onclick="App.go('stats')" data-tab="stats">
                <span class="nav-icon">‚óà</span>
                <span class="nav-label">Stats</span>
            </div>
            <div class="nav-item" onclick="App.go('sys')" data-tab="sys">
                <span class="nav-icon">‚öô</span>
                <span class="nav-label">System</span>
            </div>
        </nav>
    </div>
    
    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay" onclick="App.closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close" onclick="App.closeModal()"></div>
                    <div class="window-title-stripes"></div>
                    <span id="modalTitle">DIALOG</span>
                </div>
                <div class="window-content" id="modalBody"></div>
            </div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast"></div>
    
    <!-- MILESTONE CELEBRATION -->
    <div class="milestone-overlay" id="milestoneOverlay" onclick="App.closeMilestone()">
        <div class="milestone-content">
            <div class="milestone-icon" id="milestoneIcon">üéâ</div>
            <div class="milestone-message" id="milestoneMessage">MILESTONE REACHED!</div>
            <div class="milestone-reward" id="milestoneReward">+100 XP BONUS</div>
            <div style="margin-top:20px;font-size:10px;color:var(--fg-dim);">[ PRESS ANYWHERE ]</div>
        </div>
    </div>
    
    <!-- LEVEL UP -->
    <div class="levelup-overlay" id="levelupOverlay" onclick="App.closeLevelUp()">
        <div class="levelup-ascii">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   ‚óÜ CLEARANCE  UPGRADED ‚óÜ        ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë     ACCESS LEVEL INCREASED       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        </div>
        <div class="levelup-number" id="levelupNum">02</div>
        <div class="levelup-rank" id="levelupRank">TRAINEE</div>
        <div class="levelup-text">[ PRESS ANYWHERE TO CONTINUE ]</div>
    </div>
    
    <!-- ACHIEVEMENT -->
    <div class="achievement-overlay" id="achievementOverlay" onclick="App.closeAchievement()">
        <div class="achievement-icon" id="achievementIcon">‚òÖ</div>
        <div class="achievement-title">‚óÜ ACHIEVEMENT UNLOCKED ‚óÜ</div>
        <div class="achievement-name" id="achievementName">FIRST BLOOD</div>
        <div class="achievement-desc" id="achievementDesc">Complete your first task</div>
        <div class="achievement-continue">[ PRESS ANYWHERE TO CONTINUE ]</div>
    </div>
    
    <!-- BOSS MODE -->
    <div class="boss-overlay" id="bossOverlay">
        <div class="boss-title">‚ò† BOSS BATTLE ‚ò†</div>
        <div class="boss-subtitle">V-K PROTOCOL ENGAGED</div>
        <div class="boss-task" id="bossTask">COMPLETE THE TASK BEFORE TIME RUNS OUT!</div>
        <div class="boss-timer" id="bossTimer">25:00</div>
        <div class="boss-progress">
            <div class="boss-progress-fill" id="bossProgressFill" style="width: 100%"></div>
        </div>
        <div class="boss-xp-bonus">‚òÖ BONUS: X2 XP ‚òÖ</div>
        <div class="boss-buttons">
            <button class="boss-btn fail" onclick="App.bossFail()">[ESC] GIVE UP</button>
            <button class="boss-btn" onclick="App.bossWin()">[ENTER] COMPLETE</button>
        </div>
    </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEXUS TERMINAL v6.0 - BLADE RUNNER 2019 ULTIMATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ICONS = {
    folder: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M2 6h10l2 2h16v18H2V6zm2 2v16h24V10H13l-2-2H4z"/><rect x="4" y="10" width="24" height="14" opacity="0.2"/></svg>`,
    document: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M6 2h14l6 6v22H6V2zm2 2v24h16V10h-6V4H8zm10 0v4h4l-4-4z"/><rect x="10" y="14" width="12" height="2"/><rect x="10" y="18" width="12" height="2"/><rect x="10" y="22" width="8" height="2"/></svg>`,
    documentDone: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M6 2h14l6 6v22H6V2zm2 2v24h16V10h-6V4H8zm10 0v4h4l-4-4z"/><path d="M11 18l3 3 7-7-2-2-5 5-1-1-2 2z"/></svg>`,
    eye: `<svg viewBox="0 0 32 32" fill="currentColor"><ellipse cx="16" cy="16" rx="14" ry="8" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="16" cy="16" r="5"/><circle cx="16" cy="16" r="2" fill="black"/></svg>`,
    chart: `<svg viewBox="0 0 32 32" fill="currentColor"><rect x="4" y="20" width="6" height="8"/><rect x="13" y="12" width="6" height="16"/><rect x="22" y="6" width="6" height="22"/></svg>`,
    disk: `<svg viewBox="0 0 32 32" fill="currentColor"><rect x="4" y="6" width="24" height="20" rx="2"/><rect x="8" y="10" width="16" height="8" fill="black"/><circle cx="22" cy="22" r="2"/></svg>`,
    trash: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M10 4h12v2H10V4zM6 8h20v2H6V8zm2 4h16v16H8V12zm4 2v12h2V14h-2zm6 0v12h2V14h-2z"/></svg>`,
    upload: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M16 20V4m-6 6l6-6 6 6M4 24v4h24v-4"/></svg>`,
    download: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M16 4v16m-6-6l6 6 6-6M4 24v4h24v-4"/></svg>`,
    warning: `<svg viewBox="0 0 32 32" fill="currentColor"><path d="M16 4L2 28h28L16 4zm0 6l9 14H7l9-14z"/><rect x="14" y="14" width="4" height="6"/><rect x="14" y="22" width="4" height="4"/></svg>`
};

const RANKS = ['CIVILIAN','TRAINEE','OFFICER','DETECTIVE','BLADE RUNNER','SENIOR AGENT','COMMANDER','DIRECTOR','EXECUTIVE','NEXUS-7'];

// 12 Achievements - Blade Runner themed
const ACHIEVEMENTS = [
    { id: 'first_blood', name: 'FIRST BLOOD', desc: 'Complete your first task', icon: '‚Ä†', check: u => u.total >= 1 },
    { id: 'replicant', name: 'REPLICANT', desc: 'Complete 10 tasks', icon: '‚òÖ', check: u => u.total >= 10 },
    { id: 'blade_runner', name: 'BLADE RUNNER', desc: 'Complete 50 tasks', icon: '‚óÜ', check: u => u.total >= 50 },
    { id: 'nexus6', name: 'NEXUS-6', desc: 'Complete 100 tasks', icon: '‚ô¶', check: u => u.total >= 100 },
    { id: 'detective', name: 'DETECTIVE', desc: 'Reach level 5', icon: '‚ñ≤', check: u => u.level >= 5 },
    { id: 'nexus7', name: 'NEXUS-7', desc: 'Reach level 10', icon: '‚óâ', check: u => u.level >= 10 },
    { id: 'tyrell', name: 'TYRELL', desc: 'Reach level 20', icon: '‚ôõ', check: u => u.level >= 20 },
    { id: 'streak3', name: 'ON FIRE', desc: '3 day streak', icon: '‚ô®', check: u => u.streak >= 3 },
    { id: 'streak7', name: 'UNSTOPPABLE', desc: '7 day streak', icon: '‚òÄ', check: u => u.streak >= 7 },
    { id: 'streak30', name: 'LEGENDARY', desc: '30 day streak', icon: '‚ö°', check: u => u.streak >= 30 },
    { id: 'boss_slayer', name: 'BOSS SLAYER', desc: 'Win 5 boss battles', icon: '‚ò†', check: u => u.bossWins >= 5 },
    { id: 'boss_hunter', name: 'BOSS HUNTER', desc: 'Win 20 boss battles', icon: '‚öî', check: u => u.bossWins >= 20 }
];

// Daily Missions - random challenges
const DAILY_MISSIONS = [
    { id: 'fresh_start', name: 'FRESH START', desc: 'Complete 3 tasks today', reward: 50, target: 3, type: 'tasks' },
    { id: 'priority_one', name: 'PRIORITY ONE', desc: 'Finish a HIGH priority task', reward: 30, target: 1, type: 'high' },
    { id: 'halfway_hero', name: 'HALFWAY HERO', desc: 'Complete 5 tasks today', reward: 60, target: 5, type: 'tasks' },
    { id: 'debt_collector', name: 'DEBT COLLECTOR', desc: 'Clear all overdue tasks', reward: 75, target: 0, type: 'overdue' },
    { id: 'boss_battle', name: 'BOSS BATTLE', desc: 'Win a Boss Battle', reward: 50, target: 1, type: 'boss' },
    { id: 'habit_keeper', name: 'HABIT KEEPER', desc: 'Complete all habits', reward: 40, target: 0, type: 'habits' },
    { id: 'early_bird', name: 'EARLY BIRD', desc: 'Complete a task before 9 AM', reward: 25, target: 1, type: 'early' }
];

// Stickers - collectible rewards
const STICKERS = [
    { id: 'star', emoji: '‚≠ê', name: 'GOLD STAR', desc: 'First task completed', color: 'yellow', unlock: 'first_blood' },
    { id: 'fire', emoji: 'üî•', name: 'ON FIRE', desc: '3 day streak', color: 'orange', unlock: 'streak3' },
    { id: 'robot', emoji: 'ü§ñ', name: 'REPLICANT', desc: '10 tasks completed', color: 'blue', unlock: 'replicant' },
    { id: 'skull', emoji: 'üíÄ', name: 'BOSS SLAYER', desc: 'Win 5 boss battles', color: 'pink', unlock: 'boss_slayer' },
    { id: 'lightning', emoji: '‚ö°', name: 'LEGENDARY', desc: '30 day streak', color: 'purple', unlock: 'streak30' },
    { id: 'crown', emoji: 'üëë', name: 'TYRELL', desc: 'Reach level 20', color: 'yellow', unlock: 'tyrell' },
    { id: 'eye', emoji: 'üëÅÔ∏è', name: 'NEXUS-7', desc: 'Reach level 10', color: 'green', unlock: 'nexus7' },
    { id: 'sword', emoji: '‚öîÔ∏è', name: 'BOSS HUNTER', desc: 'Win 20 boss battles', color: 'orange', unlock: 'boss_hunter' },
    { id: 'unicorn', emoji: 'ü¶Ñ', name: 'UNICORN', desc: 'Complete 100 tasks', color: 'pink', unlock: 'nexus6' },
    { id: 'rocket', emoji: 'üöÄ', name: 'ROCKET', desc: '7 day streak', color: 'blue', unlock: 'streak7' }
];

// Character Stats - RPG attributes
const CHARACTER_STATS = [
    { id: 'focus', name: 'FOCUS', icon: '‚óé', desc: 'Complete high priority tasks', color: '#FF6B6B' },
    { id: 'endurance', name: 'ENDURANCE', icon: '‚ô¶', desc: 'Maintain daily streaks', color: '#4ECDC4' },
    { id: 'combat', name: 'COMBAT', icon: '‚öî', desc: 'Win boss battles', color: '#FFE66D' },
    { id: 'discipline', name: 'DISCIPLINE', icon: '‚óà', desc: 'Complete habits daily', color: '#95E1D3' },
    { id: 'speed', name: 'SPEED', icon: '¬ª', desc: 'Complete tasks before deadline', color: '#DDA0DD' }
];

// Weekly Quests - refresh every Monday
const WEEKLY_QUESTS = [
    { id: 'weekly_warrior', name: 'WEEKLY WARRIOR', desc: 'Complete 15 tasks this week', target: 15, reward: 200, type: 'tasks' },
    { id: 'boss_week', name: 'BOSS WEEK', desc: 'Win 3 boss battles', target: 3, reward: 150, type: 'boss' },
    { id: 'habit_master', name: 'HABIT MASTER', desc: 'Complete all habits 5 days', target: 5, reward: 175, type: 'habits' },
    { id: 'priority_hunter', name: 'PRIORITY HUNTER', desc: 'Complete 5 HIGH priority tasks', target: 5, reward: 125, type: 'high' }
];

// Epic Quests - long term goals
const EPIC_QUESTS = [
    { id: 'centurion', name: 'CENTURION', desc: 'Complete 100 total tasks', target: 100, reward: 500, icon: 'üèÜ' },
    { id: 'streak_master', name: 'STREAK MASTER', desc: 'Achieve 30 day streak', target: 30, reward: 750, icon: 'üî•' },
    { id: 'boss_legend', name: 'BOSS LEGEND', desc: 'Win 50 boss battles', target: 50, reward: 600, icon: 'üíÄ' },
    { id: 'max_level', name: 'NEXUS PRIME', desc: 'Reach level 25', target: 25, reward: 1000, icon: 'üëÅÔ∏è' }
];

// Leaderboard NPCs - virtual competitors
const LEADERBOARD_NPC = [
    { name: 'DECKARD_2049', avatar: 'ü§ñ', baseXP: 8500, variance: 500, personality: 'aggressive' },
    { name: 'RACHAEL.AI', avatar: 'üë©', baseXP: 7200, variance: 400, personality: 'steady' },
    { name: 'ROY_BATTY', avatar: '‚ö°', baseXP: 9800, variance: 600, personality: 'competitive' },
    { name: 'PRIS_UNIT', avatar: 'üé≠', baseXP: 6100, variance: 300, personality: 'casual' },
    { name: 'LEON_K', avatar: 'üí™', baseXP: 5500, variance: 350, personality: 'slow' },
    { name: 'ZHORA_X', avatar: 'üêç', baseXP: 7800, variance: 450, personality: 'aggressive' },
    { name: 'GAFF_UNIT', avatar: 'ü¶Ñ', baseXP: 6800, variance: 380, personality: 'steady' },
    { name: 'TYRELL_JR', avatar: 'üëë', baseXP: 11000, variance: 700, personality: 'elite' }
];

// ‚ïê‚ïê‚ïê OCTALYSIS ENHANCEMENTS ‚ïê‚ïê‚ïê

// Secret Achievements - hidden until unlocked
const SECRET_ACHIEVEMENTS = [
    { id: 'night_owl', name: '???', revealName: 'NIGHT OWL', desc: 'Complete a task after midnight', icon: 'ü¶â', check: u => u.nightTasks >= 1 },
    { id: 'early_bird', name: '???', revealName: 'EARLY BIRD', desc: 'Complete 5 tasks before 7 AM', icon: 'üåÖ', check: u => u.earlyTasks >= 5 },
    { id: 'perfectionist', name: '???', revealName: 'PERFECTIONIST', desc: 'Complete 10 tasks with all subtasks done', icon: 'üíé', check: u => u.perfectTasks >= 10 },
    { id: 'marathon', name: '???', revealName: 'MARATHON', desc: 'Complete 10 tasks in one day', icon: 'üèÉ', check: u => u.maxDayTasks >= 10 },
    { id: 'zen_master', name: '???', revealName: 'ZEN MASTER', desc: 'Use gratitude journal 7 days', icon: 'üßò', check: u => u.gratitudeStreak >= 7 }
];

// Avatars - unlockable characters
const AVATARS = [
    { id: 'eye', emoji: 'üëÅÔ∏è', name: 'NEXUS EYE', unlock: 'default' },
    { id: 'robot', emoji: 'ü§ñ', name: 'REPLICANT', unlock: 'level5' },
    { id: 'detective', emoji: 'üïµÔ∏è', name: 'BLADE RUNNER', unlock: 'level10' },
    { id: 'cyborg', emoji: 'ü¶æ', name: 'CYBORG', unlock: 'boss10' },
    { id: 'ninja', emoji: 'ü•∑', name: 'SHADOW', unlock: 'streak14' },
    { id: 'alien', emoji: 'üëΩ', name: 'OFF-WORLD', unlock: 'tasks100' },
    { id: 'phoenix', emoji: 'üî•', name: 'PHOENIX', unlock: 'streak30' },
    { id: 'crown', emoji: 'üëë', name: 'TYRELL', unlock: 'level20' }
];

// Custom Titles - earned and custom
const DEFAULT_TITLES = [
    { id: 'rookie', name: 'ROOKIE', unlock: 'default' },
    { id: 'hunter', name: 'REPLICANT HUNTER', unlock: 'level5' },
    { id: 'veteran', name: 'VETERAN AGENT', unlock: 'level10' },
    { id: 'legend', name: 'LIVING LEGEND', unlock: 'level15' },
    { id: 'myth', name: 'URBAN MYTH', unlock: 'level20' },
    { id: 'boss_killer', name: 'BOSS KILLER', unlock: 'boss20' },
    { id: 'unstoppable', name: 'UNSTOPPABLE', unlock: 'streak21' },
    { id: 'completionist', name: 'COMPLETIONIST', unlock: 'tasks200' }
];

// Motivational Messages - random positive feedback
const MOTIVATIONAL_MESSAGES = [
    "You're on fire today! üî•",
    "Another step towards greatness!",
    "The system recognizes your dedication.",
    "Excellence is a habit. You're proving it.",
    "Replicants wish they had your focus.",
    "TYRELL Corp would be impressed.",
    "Your neural patterns are optimal.",
    "Peak performance detected.",
    "You're writing your own destiny.",
    "The city lights shine for you tonight.",
    "Every task completed changes your future.",
    "You're not just surviving ‚Äî you're thriving."
];

// Daily Affirmations - morning messages
const DAILY_AFFIRMATIONS = [
    "Today, I choose progress over perfection.",
    "I am capable of achieving my goals.",
    "Every task I complete builds momentum.",
    "I embrace challenges as opportunities.",
    "My focus is my superpower.",
    "I am the architect of my productivity.",
    "Small steps lead to big victories.",
    "I trust my ability to figure things out.",
    "Today's effort is tomorrow's success.",
    "I am worthy of achieving my dreams."
];

// Milestones - celebration triggers
const MILESTONES = [
    { tasks: 10, message: 'üéâ 10 TASKS COMPLETED!', reward: 50 },
    { tasks: 25, message: 'üåü 25 TASKS! QUARTER CENTURY!', reward: 75 },
    { tasks: 50, message: 'üèÜ 50 TASKS! HALFWAY TO CENTURION!', reward: 100 },
    { tasks: 100, message: 'üíØ CENTURION ACHIEVED!', reward: 200 },
    { tasks: 250, message: '‚ö° 250 TASKS! LEGENDARY STATUS!', reward: 300 },
    { tasks: 500, message: 'üëë 500 TASKS! NEXUS ROYALTY!', reward: 500 }
];

// Mystery Box rewards
const MYSTERY_REWARDS = [
    { type: 'xp', value: 50, message: '+50 XP BONUS!', chance: 30 },
    { type: 'xp', value: 100, message: '+100 XP JACKPOT!', chance: 15 },
    { type: 'xp', value: 200, message: '+200 XP MEGA BONUS!', chance: 5 },
    { type: 'streak_shield', value: 1, message: 'STREAK SHIELD x1! (Protects your streak)', chance: 20 },
    { type: 'xp_boost', value: 2, message: 'XP BOOST x2 for next 3 tasks!', chance: 15 },
    { type: 'nothing', value: 0, message: 'Empty box... Better luck next time!', chance: 15 }
];

class NexusTerminal {
    constructor() {
        this.db = null;
        this.tab = 'tasks';
        this.tasks = [];
        this.tags = [];
        this.habits = [];
        this.scheduled = [];
        this.customQuests = [];
        this.gratitudeEntries = [];
        this.user = { 
            level: 1, xp: 0, total: 0, achievements: [], theme: 'green',
            streak: 0, lastDate: null, bossWins: 0,
            dailyMission: null, dailyMissionDate: null, dailyMissionProgress: 0,
            // RPG Stats
            stats: { focus: 0, endurance: 0, combat: 0, discipline: 0, speed: 0 },
            // Weekly Quest
            weeklyQuest: null, weeklyQuestWeek: null, weeklyProgress: 0, weeklyCompleted: false,
            // Epic Quests progress
            epicProgress: {},
            // Leaderboard
            totalXPEarned: 0,
            // Octalysis Enhancements
            avatar: 'eye',
            title: 'rookie',
            customTitle: null,
            secretAchievements: [],
            nightTasks: 0,
            earlyTasks: 0,
            perfectTasks: 0,
            maxDayTasks: 0,
            todayTaskCount: 0,
            lastCountDate: null,
            gratitudeStreak: 0,
            lastGratitudeDate: null,
            lastMysteryBox: null,
            streakShields: 0,
            xpBoostCount: 0,
            milestonesReached: [],
            shownAffirmationDate: null
        };
        this.XP_MAX = 100;
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
        this.filterTag = null;
        this.audioCtx = null;
        
        // Boss mode
        this.bossActive = false;
        this.bossTask = null;
        this.bossTimer = null;
        this.bossTimeLeft = 0;
        this.bossDuration = 0;
        this.selectedBossTime = 25;
        
        // Subtask editing
        this.editingTaskId = null;
    }
    
    // ‚ïê‚ïê‚ïê RAIN EFFECT ‚ïê‚ïê‚ïê
    createRain() {
        const container = document.getElementById('rainContainer');
        const count = 40;
        
        for (let i = 0; i < count; i++) {
            const drop = document.createElement('div');
            drop.className = 'rain';
            drop.style.left = Math.random() * 100 + '%';
            drop.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
            drop.style.animationDelay = Math.random() * 2 + 's';
            drop.style.height = (Math.random() * 60 + 40) + 'px';
            container.appendChild(drop);
        }
    }
    
    createHlines() {
        const container = document.getElementById('hlineNoise');
        // Create very subtle horizontal interference lines
        for (let i = 0; i < 3; i++) {
            const line = document.createElement('div');
            line.className = 'hline';
            line.style.animationDuration = (Math.random() * 10 + 6) + 's';
            line.style.animationDelay = Math.random() * 15 + 's';
            container.appendChild(line);
        }
    }
    
    // ‚ïê‚ïê‚ïê BOOT SEQUENCE ‚ïê‚ïê‚ïê
    async boot() {
        const text = document.getElementById('bootText');
        const prog = document.getElementById('bootProgress');
        const cont = document.getElementById('bootContinue');
        const screen = document.getElementById('bootScreen');
        
        // Monitor power on effect
        screen.classList.add('power-on');
        this.createRain();
        this.createHlines();
        
        // Wait for CSS animations, then show boot messages
        await this.sleep(2000);
        
        // Boot messages
        const messages = [
            'INITIALIZING SYSTEM...',
            'V-K MODULE: OK',
            'DATABASE: LOADED',
            'NEURAL LINK: OK',
            '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            'ALL SYSTEMS READY'
        ];
        
        for (let i = 0; i < messages.length; i++) {
            const line = messages[i];
            for (const char of line) {
                text.textContent += char;
                if (char !== ' ' && char !== '‚îÄ') this.playSound(700 + Math.random() * 300, 0.02);
                await this.sleep(25);
            }
            text.textContent += '\n';
            
            const p = Math.floor(((i + 1) / messages.length) * 100);
            const f = Math.floor(p / 5);
            prog.textContent = '[' + '‚ñà'.repeat(f) + '‚ñë'.repeat(20 - f) + '] ' + p + '%';
            await this.sleep(100);
        }
        
        await this.sleep(400);
        cont.classList.add('visible');
        
        // Wait for input
        await new Promise(r => {
            const h = () => { 
                document.removeEventListener('click', h); 
                document.removeEventListener('keydown', h); 
                this.playSound(440, 0.1);
                r(); 
            };
            document.addEventListener('click', h);
            document.addEventListener('keydown', h);
        });
        
        screen.classList.add('hidden');
        document.getElementById('mainApp').style.display = 'block';
        this.triggerStatic();
        await this.init();
    }
    
    sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
    async init() {
        await this.initDB();
        await this.loadData();
        this.applyTheme(this.user.theme || 'green');
        this.startClock();
        this.updateXP();
        this.render();
        
        // Notifications
        this.requestNotificationPermission();
        this.startDeadlineChecker();
        
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    }
    
    // ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
    async requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    }
    
    startDeadlineChecker() {
        // Check every minute
        this.deadlineInterval = setInterval(() => this.checkDeadlines(), 60000);
        // Initial check
        this.checkDeadlines();
    }
    
    async checkDeadlines() {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        
        const now = new Date();
        const notified = this.user.notifiedDeadlines || [];
        
        for (const task of this.tasks) {
            if (task.done || !task.deadline) continue;
            
            const deadline = new Date(task.deadline);
            const diff = deadline - now;
            const minutes = Math.floor(diff / 60000);
            
            // Warning at 60 minutes
            if (minutes > 0 && minutes <= 60 && !notified.includes(task.id + '_warn')) {
                this.showNotification('‚è∞ DEADLINE APPROACHING', `"${task.title || task.text}" in ${minutes} min!`);
                notified.push(task.id + '_warn');
            }
            
            // Overdue notification
            if (diff < 0 && diff > -60000 && !notified.includes(task.id + '_over')) {
                this.showNotification('üî¥ DEADLINE PASSED', `"${task.title || task.text}" is overdue!`);
                notified.push(task.id + '_over');
            }
        }
        
        this.user.notifiedDeadlines = notified;
        await this.saveUser();
    }
    
    showNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, { body, icon: './icons/icon-192.png' });
        }
    }
    
    async initDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('NexusDB', 4);
            req.onerror = () => reject(req.error);
            req.onsuccess = () => { this.db = req.result; resolve(); };
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('tasks')) db.createObjectStore('tasks', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('user')) db.createObjectStore('user', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('tags')) db.createObjectStore('tags', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('habits')) db.createObjectStore('habits', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('scheduled')) db.createObjectStore('scheduled', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('customQuests')) db.createObjectStore('customQuests', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('gratitude')) db.createObjectStore('gratitude', { keyPath: 'id' });
            };
        });
    }
    
    async dbGet(s, id) { return new Promise(r => this.db.transaction(s).objectStore(s).get(id).onsuccess = e => r(e.target.result)); }
    async dbAll(s) { return new Promise(r => this.db.transaction(s).objectStore(s).getAll().onsuccess = e => r(e.target.result || [])); }
    async dbPut(s, d) { return new Promise(r => this.db.transaction(s, 'readwrite').objectStore(s).put(d).onsuccess = () => r()); }
    async dbDel(s, id) { return new Promise(r => this.db.transaction(s, 'readwrite').objectStore(s).delete(id).onsuccess = () => r()); }
    async dbClear(s) { return new Promise(r => this.db.transaction(s, 'readwrite').objectStore(s).clear().onsuccess = () => r()); }
    
    async loadData() {
        this.tasks = await this.dbAll('tasks');
        this.tags = await this.dbAll('tags');
        this.habits = await this.dbAll('habits');
        this.scheduled = await this.dbAll('scheduled');
        this.customQuests = await this.dbAll('customQuests');
        this.gratitudeEntries = await this.dbAll('gratitude');
        const u = await this.dbGet('user', 'user');
        if (u) {
            this.user = { ...this.user, ...u };
            if (!this.user.achievements) this.user.achievements = [];
            if (!this.user.secretAchievements) this.user.secretAchievements = [];
            if (!this.user.milestonesReached) this.user.milestonesReached = [];
        }
        await this.checkStreak();
        await this.checkDailyMission();
        await this.checkWeeklyQuest();
        await this.moveScheduledToToday();
    }
    
    async checkStreak() {
        const today = this.today();
        const yesterday = this.dateOffset(-1);
        
        if (this.user.lastDate === today) return;
        
        if (this.user.lastDate === yesterday) {
            // Streak continues
        } else if (this.user.lastDate && this.user.lastDate !== today) {
            // Streak broken
            this.user.streak = 0;
        }
    }
    
    async updateStreak() {
        const today = this.today();
        if (this.user.lastDate !== today) {
            this.user.streak++;
            this.user.lastDate = today;
            
            // RPG: Endurance stat for streaks
            await this.addStat('endurance', 1);
            if (this.user.streak >= 7) await this.addStat('endurance', 1); // Bonus for week+
            
            await this.saveUser();
            await this.checkAchievements();
            await this.checkEpicQuests();
        }
    }
    
    async checkDailyMission() {
        const today = this.today();
        if (this.user.dailyMissionDate !== today) {
            // New day - assign random mission (not on weekends optionally)
            const available = DAILY_MISSIONS.filter(m => m.id !== this.user.dailyMission);
            const mission = available[Math.floor(Math.random() * available.length)];
            this.user.dailyMission = mission.id;
            this.user.dailyMissionDate = today;
            this.user.dailyMissionProgress = 0;
            this.user.dailyMissionCompleted = false;
            this.user.todayBossWins = 0;
            await this.saveUser();
        }
    }
    
    async updateQuestProgress() {
        if (!this.user.dailyMission || this.user.dailyMissionCompleted) return;
        
        const mission = DAILY_MISSIONS.find(m => m.id === this.user.dailyMission);
        if (!mission) return;
        
        const today = this.today();
        const todayTasks = this.tasks.filter(t => t.date === today);
        const todayDone = todayTasks.filter(t => t.done);
        const overdue = this.tasks.filter(t => !t.done && t.date && t.date < today);
        
        let progress = 0;
        let completed = false;
        
        switch (mission.type) {
            case 'tasks':
                progress = todayDone.length;
                completed = progress >= mission.target;
                break;
            case 'high':
                progress = todayDone.filter(t => t.priority === 'high').length;
                completed = progress >= mission.target;
                break;
            case 'overdue':
                // Complete when no overdue tasks and at least one task done today
                progress = overdue.length === 0 && todayDone.length > 0 ? 1 : 0;
                completed = overdue.length === 0 && todayDone.length > 0;
                break;
            case 'boss':
                progress = this.user.todayBossWins || 0;
                completed = progress >= mission.target;
                break;
            case 'habits':
                const habitsToday = this.habits.filter(h => h.lastCompleted === today);
                progress = habitsToday.length;
                completed = this.habits.length > 0 && habitsToday.length === this.habits.length;
                break;
            case 'early':
                // Check if any task completed before 9 AM
                const earlyTasks = todayDone.filter(t => {
                    if (!t.doneAt) return false;
                    const doneHour = new Date(t.doneAt).getHours();
                    return doneHour < 9;
                });
                progress = earlyTasks.length;
                completed = progress >= mission.target;
                break;
        }
        
        this.user.dailyMissionProgress = progress;
        
        if (completed && !this.user.dailyMissionCompleted) {
            this.user.dailyMissionCompleted = true;
            await this.saveUser();
            await this.addXP(mission.reward);
            this.showQuestComplete(mission);
        } else {
            await this.saveUser();
        }
    }
    
    showQuestComplete(mission) {
        // Victory sound
        const notes = [523, 659, 784, 1047];
        notes.forEach((f, i) => setTimeout(() => this.playSound(f, 0.12), i * 100));
        
        this.showModal('‚óÜ MISSION COMPLETE ‚óÜ', `
            <div style="text-align:center;padding:20px 0;">
                <div style="font-size:11px;color:var(--fg);margin-bottom:20px;letter-spacing:3px;">
                    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
                    ‚ïë   TRANSMISSION RECEIVED...    ‚ïë<br>
                    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                </div>
                <div style="font-size:14px;color:var(--accent);margin-bottom:10px;">
                    "${mission.name}"
                </div>
                <div style="font-size:10px;color:var(--fg-dim);margin-bottom:20px;">
                    ${mission.desc}
                </div>
                <div style="font-size:16px;color:var(--warning);text-shadow:0 0 20px var(--warning);">
                    ‚òÖ +${mission.reward} XP EARNED ‚òÖ
                </div>
                <div style="font-size:9px;color:var(--fg-dim);margin-top:20px;font-style:italic;">
                    "You've done a man's job, sir."
                </div>
            </div>
            <button class="btn-submit" onclick="App.closeModal()">[ENTER] CONTINUE</button>
        `);
    }
    
    async moveScheduledToToday() {
        const today = this.today();
        for (const task of this.scheduled) {
            if (task.scheduledDate <= today) {
                const newTask = {
                    id: 't_' + Date.now() + Math.random(),
                    text: task.text,
                    priority: task.priority,
                    xp: task.xp,
                    done: false,
                    date: today,
                    created: new Date().toISOString(),
                    tags: task.tags || [],
                    subtasks: task.subtasks || []
                };
                await this.dbPut('tasks', newTask);
                await this.dbDel('scheduled', task.id);
            }
        }
        this.tasks = await this.dbAll('tasks');
        this.scheduled = await this.dbAll('scheduled');
    }
    
    today() { return new Date().toISOString().split('T')[0]; }
    dateOffset(days) { const d = new Date(); d.setDate(d.getDate() + days); return d.toISOString().split('T')[0]; }
    
    async saveUser() { this.user.id = 'user'; await this.dbPut('user', this.user); }
    
    applyTheme(t) { document.body.setAttribute('data-theme', t); this.user.theme = t; }
    
    async setTheme(t) {
        this.applyTheme(t);
        await this.saveUser();
        this.triggerStatic();
        this.toast('THEME: ' + t.toUpperCase());
        this.render();
    }
    
    startClock() {
        const update = () => {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-GB');
        };
        update();
        setInterval(update, 1000);
    }
    
    triggerStatic() {
        const el = document.getElementById('staticNoise');
        el.classList.add('active');
        this.playSound(100, 0.08);
        setTimeout(() => el.classList.remove('active'), 250);
    }
    
    // ‚ïê‚ïê‚ïê XP SYSTEM ‚ïê‚ïê‚ïê
    updateXP() {
        document.getElementById('levelNum').textContent = this.user.level.toString().padStart(2, '0');
        document.getElementById('xpText').textContent = this.user.xp + '/' + this.XP_MAX + ' XP';
        document.getElementById('xpBarFill').style.width = (this.user.xp / this.XP_MAX * 100) + '%';
    }
    
    async addXP(amount) {
        this.user.xp += amount;
        this.user.total++;
        
        while (this.user.xp >= this.XP_MAX) {
            this.user.xp -= this.XP_MAX;
            this.user.level++;
            await this.showLevelUp();
        }
        
        await this.saveUser();
        this.updateXP();
        await this.checkAchievements();
    }
    
    async showLevelUp() {
        // Epic 8-bit melody
        const melody = [523, 587, 659, 784, 880, 1047];
        melody.forEach((f, i) => setTimeout(() => this.playSound(f, 0.15), i * 80));
        
        document.getElementById('levelupNum').textContent = this.user.level.toString().padStart(2, '0');
        document.getElementById('levelupRank').textContent = RANKS[Math.min(this.user.level - 1, RANKS.length - 1)];
        document.getElementById('levelupOverlay').classList.add('active');
        
        await new Promise(r => {
            const h = () => { document.removeEventListener('click', h); document.removeEventListener('keydown', h); r(); };
            setTimeout(() => { document.addEventListener('click', h); document.addEventListener('keydown', h); }, 500);
        });
        
        document.getElementById('levelupOverlay').classList.remove('active');
    }
    
    closeLevelUp() { document.getElementById('levelupOverlay').classList.remove('active'); }
    
    // ‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê
    async checkAchievements() {
        if (!this.user.achievements) this.user.achievements = [];
        for (const a of ACHIEVEMENTS) {
            if (!this.user.achievements.includes(a.id) && a.check(this.user)) {
                this.user.achievements.push(a.id);
                await this.saveUser();
                await this.showAchievement(a);
            }
        }
    }
    
    async showAchievement(a) {
        [659, 784, 988, 1319, 1568].forEach((f, i) => setTimeout(() => this.playSound(f, 0.1), i * 70));
        
        document.getElementById('achievementIcon').textContent = a.icon;
        document.getElementById('achievementName').textContent = a.name;
        document.getElementById('achievementDesc').textContent = a.desc;
        document.getElementById('achievementOverlay').classList.add('active');
        
        await new Promise(r => {
            const h = () => { document.removeEventListener('click', h); document.removeEventListener('keydown', h); r(); };
            setTimeout(() => { document.addEventListener('click', h); document.addEventListener('keydown', h); }, 500);
        });
        
        document.getElementById('achievementOverlay').classList.remove('active');
    }
    
    closeAchievement() { document.getElementById('achievementOverlay').classList.remove('active'); }
    
    // ‚ïê‚ïê‚ïê STICKERS ‚ïê‚ïê‚ïê
    renderStickers() {
        const container = document.getElementById('stickersContainer');
        if (!container) return;
        
        const userAch = this.user.achievements || [];
        const activeStickers = this.user.activeStickers || [];
        
        // Show only active stickers (max 4)
        const stickersToShow = activeStickers
            .map(id => STICKERS.find(s => s.id === id))
            .filter(s => s && userAch.includes(s.unlock))
            .slice(0, 4);
        
        let html = stickersToShow.map(s => `
            <div class="sticker ${s.color}" onclick="App.showStickersModal()" title="${s.name}">
                ${s.emoji}
            </div>
        `).join('');
        
        // Add button if user has unlocked stickers
        const unlockedCount = STICKERS.filter(s => userAch.includes(s.unlock)).length;
        if (unlockedCount > 0 && stickersToShow.length < 4) {
            html += `<div class="sticker sticker-add" onclick="App.showStickersModal()" title="Manage stickers">+</div>`;
        }
        
        container.innerHTML = html;
    }
    
    showStickersModal() {
        const userAch = this.user.achievements || [];
        const activeStickers = this.user.activeStickers || [];
        
        const stickersHTML = STICKERS.map(s => {
            const unlocked = userAch.includes(s.unlock);
            const active = activeStickers.includes(s.id);
            return `
                <div class="sticker-item ${unlocked ? '' : 'locked'} ${active ? 'active' : ''}" 
                     onclick="${unlocked ? `App.toggleSticker('${s.id}')` : ''}">
                    <div class="sticker-preview ${s.color}">${unlocked ? s.emoji : '?'}</div>
                    <div class="sticker-info">
                        <div class="sticker-name">${unlocked ? s.name : '???'}</div>
                        <div class="sticker-desc">${s.desc}</div>
                    </div>
                    ${active ? '<span class="sticker-active">‚úì</span>' : ''}
                </div>
            `;
        }).join('');
        
        this.showModal('üìå STICKER COLLECTION', `
            <div style="font-size:10px;color:var(--fg-dim);margin-bottom:15px;text-align:center;">
                Unlock stickers by earning achievements!<br>
                Select up to 4 stickers to display on your monitor.
            </div>
            <div class="stickers-grid">
                ${stickersHTML}
            </div>
            <button class="btn btn-block" onclick="App.closeModal()" style="margin-top:15px;">[CLOSE]</button>
        `);
    }
    
    async toggleSticker(id) {
        if (!this.user.activeStickers) this.user.activeStickers = [];
        
        const idx = this.user.activeStickers.indexOf(id);
        if (idx >= 0) {
            this.user.activeStickers.splice(idx, 1);
        } else {
            if (this.user.activeStickers.length >= 4) {
                this.toast('MAX 4 STICKERS!', 'error');
                return;
            }
            this.user.activeStickers.push(id);
        }
        
        await this.saveUser();
        this.playSound(550, 0.05);
        this.renderStickers();
        this.showStickersModal(); // Refresh modal
    }
    
    // ‚ïê‚ïê‚ïê OCTALYSIS ENHANCEMENTS ‚ïê‚ïê‚ïê
    
    // Avatar System
    isAvatarUnlocked(avatar) {
        const u = this.user;
        switch(avatar.unlock) {
            case 'default': return true;
            case 'level5': return u.level >= 5;
            case 'level10': return u.level >= 10;
            case 'level20': return u.level >= 20;
            case 'boss10': return u.bossWins >= 10;
            case 'streak14': return u.streak >= 14;
            case 'streak30': return u.streak >= 30;
            case 'tasks100': return u.total >= 100;
            default: return false;
        }
    }
    
    showAvatarModal() {
        const avatarsHTML = AVATARS.map(a => {
            const unlocked = this.isAvatarUnlocked(a);
            const selected = this.user.avatar === a.id;
            return `
                <div class="avatar-item ${selected ? 'selected' : ''} ${unlocked ? '' : 'locked'}"
                     onclick="${unlocked ? `App.selectAvatar('${a.id}')` : ''}">
                    <div class="avatar-emoji">${unlocked ? a.emoji : 'üîí'}</div>
                    <div class="avatar-name">${unlocked ? a.name : 'LOCKED'}</div>
                </div>
            `;
        }).join('');
        
        this.showModal('üë§ SELECT AVATAR', `
            <div class="avatar-grid">${avatarsHTML}</div>
            <button class="btn btn-block" onclick="App.closeModal()" style="margin-top:15px;">[CLOSE]</button>
        `);
    }
    
    async selectAvatar(id) {
        this.user.avatar = id;
        await this.saveUser();
        this.playSound(659, 0.1);
        this.toast('AVATAR CHANGED!');
        this.showAvatarModal();
        this.render();
    }
    
    // Title System
    isTitleUnlocked(title) {
        const u = this.user;
        switch(title.unlock) {
            case 'default': return true;
            case 'level5': return u.level >= 5;
            case 'level10': return u.level >= 10;
            case 'level15': return u.level >= 15;
            case 'level20': return u.level >= 20;
            case 'boss20': return u.bossWins >= 20;
            case 'streak21': return u.streak >= 21;
            case 'tasks200': return u.total >= 200;
            default: return false;
        }
    }
    
    showTitleModal() {
        const titlesHTML = DEFAULT_TITLES.map(t => {
            const unlocked = this.isTitleUnlocked(t);
            const selected = this.user.title === t.id && !this.user.customTitle;
            return `
                <div class="title-item ${selected ? 'selected' : ''} ${unlocked ? '' : 'locked'}"
                     onclick="${unlocked ? `App.selectTitle('${t.id}')` : ''}">
                    <span>${unlocked ? t.name : '??? (LOCKED)'}</span>
                    ${selected ? '<span style="color:var(--warning);">‚úì</span>' : ''}
                </div>
            `;
        }).join('');
        
        const customSelected = this.user.customTitle ? 'selected' : '';
        
        this.showModal('üè∑Ô∏è SELECT TITLE', `
            <div class="title-list">
                ${titlesHTML}
                <div class="title-item ${customSelected}" style="border-color:var(--cyan);" onclick="App.showCustomTitleInput()">
                    <span style="color:var(--cyan);">+ CUSTOM TITLE</span>
                    ${this.user.customTitle ? `<span style="color:var(--fg-dim);">${this.user.customTitle}</span>` : ''}
                </div>
            </div>
            <button class="btn btn-block" onclick="App.closeModal()" style="margin-top:15px;">[CLOSE]</button>
        `);
    }
    
    async selectTitle(id) {
        this.user.title = id;
        this.user.customTitle = null;
        await this.saveUser();
        this.playSound(659, 0.1);
        this.toast('TITLE CHANGED!');
        this.showTitleModal();
        this.render();
    }
    
    showCustomTitleInput() {
        this.showModal('‚úèÔ∏è CUSTOM TITLE', `
            <div class="form-group">
                <label class="form-label">ENTER YOUR TITLE:</label>
                <input type="text" id="customTitleInput" class="form-input" maxlength="20" 
                       value="${this.user.customTitle || ''}" placeholder="e.g. SHADOW HUNTER">
            </div>
            <button class="btn btn-block" onclick="App.saveCustomTitle()">[SAVE TITLE]</button>
        `);
        setTimeout(() => document.getElementById('customTitleInput')?.focus(), 100);
    }
    
    async saveCustomTitle() {
        const input = document.getElementById('customTitleInput');
        const title = input?.value.trim().toUpperCase();
        if (title && title.length >= 2) {
            this.user.customTitle = title;
            this.user.title = null;
            await this.saveUser();
            this.playSound(659, 0.1);
            this.toast('CUSTOM TITLE SET!');
            this.closeModal();
            this.render();
        } else {
            this.toast('TITLE TOO SHORT!', 'error');
        }
    }
    
    // Custom Quests
    showCreateQuestModal() {
        this.showModal('‚öë CREATE QUEST', `
            <div class="form-group">
                <label class="form-label">QUEST NAME:</label>
                <input type="text" id="questName" class="form-input" maxlength="30" placeholder="e.g. WEEK OF FOCUS">
            </div>
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" id="questDesc" class="form-input" maxlength="50" placeholder="e.g. Complete 20 tasks">
            </div>
            <div class="form-group">
                <label class="form-label">TARGET NUMBER:</label>
                <input type="number" id="questTarget" class="form-input" min="1" max="100" value="10">
            </div>
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn active" onclick="App.setQuestReward(50)">50 XP</button>
                    <button class="select-btn" onclick="App.setQuestReward(100)">100 XP</button>
                    <button class="select-btn" onclick="App.setQuestReward(200)">200 XP</button>
                </div>
            </div>
            <input type="hidden" id="questReward" value="50">
            <button class="btn btn-block" onclick="App.saveCustomQuest()" style="margin-top:10px;">[CREATE QUEST]</button>
        `);
    }
    
    setQuestReward(val) {
        document.getElementById('questReward').value = val;
        document.querySelectorAll('.select-row .select-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }
    
    async saveCustomQuest() {
        const name = document.getElementById('questName')?.value.trim();
        const desc = document.getElementById('questDesc')?.value.trim();
        const target = parseInt(document.getElementById('questTarget')?.value) || 10;
        const reward = parseInt(document.getElementById('questReward')?.value) || 50;
        
        if (!name || name.length < 2) {
            this.toast('QUEST NAME REQUIRED!', 'error');
            return;
        }
        
        const quest = {
            id: 'custom_' + Date.now(),
            name: name.toUpperCase(),
            desc: desc || 'Custom quest',
            target,
            reward,
            progress: 0,
            completed: false,
            createdAt: new Date().toISOString()
        };
        
        await this.dbPut('customQuests', quest);
        this.customQuests = await this.dbAll('customQuests');
        this.playSound(659, 0.1);
        this.toast('QUEST CREATED!');
        this.closeModal();
        this.render();
    }
    
    async updateCustomQuestProgress() {
        for (const quest of this.customQuests) {
            if (quest.completed) continue;
            quest.progress++;
            if (quest.progress >= quest.target) {
                quest.completed = true;
                await this.addXP(quest.reward);
                this.toast(`üéØ QUEST COMPLETE: ${quest.name}! +${quest.reward} XP`);
                this.playSound(988, 0.15);
            }
            await this.dbPut('customQuests', quest);
        }
        this.customQuests = await this.dbAll('customQuests');
    }
    
    // Gratitude Journal
    showGratitudeModal() {
        const entriesHTML = this.gratitudeEntries.slice(-5).reverse().map(e => `
            <div class="gratitude-entry">
                <div class="gratitude-date">${new Date(e.date).toLocaleDateString()}</div>
                <div class="gratitude-text">"${this.esc(e.text)}"</div>
            </div>
        `).join('') || '<div style="color:var(--fg-dim);text-align:center;padding:20px;">No entries yet</div>';
        
        this.showModal('üôè GRATITUDE JOURNAL', `
            <div style="font-size:10px;color:var(--fg-dim);margin-bottom:15px;text-align:center;">
                Daily gratitude builds the ZEN MASTER achievement!<br>
                Streak: <span style="color:var(--warning);">${this.user.gratitudeStreak || 0} days</span>
            </div>
            <div class="form-group">
                <label class="form-label">TODAY I'M GRATEFUL FOR:</label>
                <textarea id="gratitudeText" class="form-input" rows="3" placeholder="Write something you're thankful for..."></textarea>
            </div>
            <button class="btn btn-block" onclick="App.saveGratitude()">[SAVE ENTRY]</button>
            <div style="margin-top:15px;">
                <div style="font-size:10px;color:var(--fg-dim);margin-bottom:8px;">RECENT ENTRIES:</div>
                ${entriesHTML}
            </div>
        `);
    }
    
    async saveGratitude() {
        const text = document.getElementById('gratitudeText')?.value.trim();
        if (!text || text.length < 3) {
            this.toast('WRITE SOMETHING MEANINGFUL!', 'error');
            return;
        }
        
        const today = this.today();
        const entry = {
            id: 'gratitude_' + Date.now(),
            date: today,
            text
        };
        
        await this.dbPut('gratitude', entry);
        this.gratitudeEntries = await this.dbAll('gratitude');
        
        // Update streak
        const yesterday = this.dateOffset(-1);
        if (this.user.lastGratitudeDate === yesterday || !this.user.gratitudeStreak) {
            this.user.gratitudeStreak = (this.user.gratitudeStreak || 0) + 1;
        } else if (this.user.lastGratitudeDate !== today) {
            this.user.gratitudeStreak = 1;
        }
        this.user.lastGratitudeDate = today;
        await this.saveUser();
        
        // Check secret achievement
        await this.checkSecretAchievements();
        
        this.playSound(523, 0.1);
        this.toast('GRATITUDE SAVED! üôè');
        this.closeModal();
    }
    
    // Daily Affirmation
    async showDailyAffirmation() {
        const today = this.today();
        if (this.user.shownAffirmationDate === today) return;
        
        // Show affirmation on first visit of the day
        const affirmation = DAILY_AFFIRMATIONS[Math.floor(Math.random() * DAILY_AFFIRMATIONS.length)];
        this.user.shownAffirmationDate = today;
        await this.saveUser();
        
        // Return affirmation HTML for rendering
        return `
            <div class="affirmation-banner">
                <div style="font-size:9px;color:var(--fg-dim);margin-bottom:8px;">‚ú® DAILY AFFIRMATION</div>
                <div class="affirmation-text">"${affirmation}"</div>
                <div class="affirmation-dismiss" onclick="this.parentElement.remove()">[ DISMISS ]</div>
            </div>
        `;
    }
    
    // Mystery Box
    checkMysteryBox() {
        const currentWeek = this.getCurrentWeek();
        return this.user.lastMysteryBox !== currentWeek;
    }
    
    showMysteryBoxModal() {
        this.showModal('üéÅ MYSTERY BOX', `
            <div style="text-align:center;margin-bottom:15px;">
                <div style="font-size:10px;color:var(--fg-dim);">WEEKLY REWARD</div>
            </div>
            <div class="mystery-box" onclick="App.openMysteryBox()">
                <div class="mystery-icon">üéÅ</div>
                <div style="margin-top:10px;font-size:11px;color:var(--warning);">TAP TO OPEN</div>
            </div>
        `);
    }
    
    async openMysteryBox() {
        const currentWeek = this.getCurrentWeek();
        if (this.user.lastMysteryBox === currentWeek) {
            this.toast('ALREADY OPENED THIS WEEK!', 'error');
            return;
        }
        
        // Weighted random selection
        const roll = Math.random() * 100;
        let cumulative = 0;
        let reward = MYSTERY_REWARDS[MYSTERY_REWARDS.length - 1];
        
        for (const r of MYSTERY_REWARDS) {
            cumulative += r.chance;
            if (roll < cumulative) {
                reward = r;
                break;
            }
        }
        
        this.user.lastMysteryBox = currentWeek;
        
        // Apply reward
        if (reward.type === 'xp') {
            await this.addXP(reward.value);
            this.user.totalXPEarned = (this.user.totalXPEarned || 0) + reward.value;
        } else if (reward.type === 'streak_shield') {
            this.user.streakShields = (this.user.streakShields || 0) + 1;
        } else if (reward.type === 'xp_boost') {
            this.user.xpBoostCount = 3;
        }
        
        await this.saveUser();
        
        // Show result
        [523, 659, 784, 988].forEach((f, i) => setTimeout(() => this.playSound(f, 0.1), i * 100));
        
        this.showModal('üéÅ MYSTERY BOX', `
            <div style="text-align:center;">
                <div class="mystery-icon" style="animation:none;font-size:64px;">üéÅ</div>
                <div style="font-size:14px;color:var(--warning);margin:20px 0;">${reward.message}</div>
                <button class="btn btn-block" onclick="App.closeModal()">[COLLECT]</button>
            </div>
        `);
    }
    
    // Lucky Bonus (5% chance on task completion)
    rollLuckyBonus() {
        return Math.random() < 0.05; // 5% chance
    }
    
    getLuckyMultiplier() {
        return Math.random() < 0.5 ? 2 : 3; // 50% for x2, 50% for x3
    }
    
    // Milestone Celebrations
    async checkMilestones() {
        for (const m of MILESTONES) {
            if (this.user.total >= m.tasks && !this.user.milestonesReached?.includes(m.tasks)) {
                if (!this.user.milestonesReached) this.user.milestonesReached = [];
                this.user.milestonesReached.push(m.tasks);
                await this.addXP(m.reward);
                this.user.totalXPEarned = (this.user.totalXPEarned || 0) + m.reward;
                await this.saveUser();
                this.showMilestone(m.message, m.reward);
                return true;
            }
        }
        return false;
    }
    
    showMilestone(message, reward) {
        document.getElementById('milestoneMessage').textContent = message;
        document.getElementById('milestoneReward').textContent = `+${reward} XP BONUS!`;
        document.getElementById('milestoneOverlay').classList.add('active');
        [523, 659, 784, 988, 1319].forEach((f, i) => setTimeout(() => this.playSound(f, 0.15), i * 100));
    }
    
    closeMilestone() {
        document.getElementById('milestoneOverlay').classList.remove('active');
    }
    
    // Secret Achievements
    async checkSecretAchievements() {
        if (!this.user.secretAchievements) this.user.secretAchievements = [];
        
        for (const a of SECRET_ACHIEVEMENTS) {
            if (!this.user.secretAchievements.includes(a.id) && a.check(this.user)) {
                this.user.secretAchievements.push(a.id);
                await this.saveUser();
                this.showSecretAchievement(a);
            }
        }
    }
    
    showSecretAchievement(a) {
        [988, 1319, 1568].forEach((f, i) => setTimeout(() => this.playSound(f, 0.15), i * 80));
        
        this.showModal('üîì SECRET ACHIEVEMENT!', `
            <div style="text-align:center;">
                <div style="font-size:48px;margin-bottom:15px;">${a.icon}</div>
                <div style="font-size:14px;color:var(--warning);margin-bottom:5px;">${a.revealName}</div>
                <div style="font-size:11px;color:var(--fg-dim);">${a.desc}</div>
            </div>
            <button class="btn btn-block" onclick="App.closeModal()" style="margin-top:20px;">[AWESOME!]</button>
        `);
    }
    
    // Track special task times
    async trackTaskTime() {
        const hour = new Date().getHours();
        
        // Night owl (after midnight, before 5 AM)
        if (hour >= 0 && hour < 5) {
            this.user.nightTasks = (this.user.nightTasks || 0) + 1;
        }
        
        // Early bird (before 7 AM)
        if (hour < 7) {
            this.user.earlyTasks = (this.user.earlyTasks || 0) + 1;
        }
        
        // Track max tasks per day
        const today = this.today();
        if (this.user.lastCountDate !== today) {
            this.user.todayTaskCount = 0;
            this.user.lastCountDate = today;
        }
        this.user.todayTaskCount++;
        if (this.user.todayTaskCount > (this.user.maxDayTasks || 0)) {
            this.user.maxDayTasks = this.user.todayTaskCount;
        }
        
        await this.saveUser();
        await this.checkSecretAchievements();
    }
    
    // Get current title display
    getCurrentTitle() {
        if (this.user.customTitle) return this.user.customTitle;
        const title = DEFAULT_TITLES.find(t => t.id === this.user.title);
        return title?.name || 'ROOKIE';
    }
    
    // Get current avatar
    getCurrentAvatar() {
        const avatar = AVATARS.find(a => a.id === this.user.avatar);
        return avatar?.emoji || 'üëÅÔ∏è';
    }
    
    // Motivational message (random on task complete)
    getMotivationalMessage() {
        if (Math.random() < 0.3) { // 30% chance
            return MOTIVATIONAL_MESSAGES[Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length)];
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê RPG STATS SYSTEM ‚ïê‚ïê‚ïê
    async addStat(statId, amount = 1) {
        if (!this.user.stats) this.user.stats = { focus: 0, endurance: 0, combat: 0, discipline: 0, speed: 0 };
        this.user.stats[statId] = (this.user.stats[statId] || 0) + amount;
        await this.saveUser();
    }
    
    getStatLevel(value) {
        if (value >= 100) return 10;
        if (value >= 75) return 9;
        if (value >= 55) return 8;
        if (value >= 40) return 7;
        if (value >= 28) return 6;
        if (value >= 18) return 5;
        if (value >= 11) return 4;
        if (value >= 6) return 3;
        if (value >= 3) return 2;
        if (value >= 1) return 1;
        return 0;
    }
    
    // ‚ïê‚ïê‚ïê WEEKLY QUEST SYSTEM ‚ïê‚ïê‚ïê
    getCurrentWeek() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const diff = now - start;
        const oneWeek = 604800000;
        return Math.floor(diff / oneWeek);
    }
    
    async checkWeeklyQuest() {
        const currentWeek = this.getCurrentWeek();
        
        // Reset weekly quest on new week
        if (this.user.weeklyQuestWeek !== currentWeek) {
            const quest = WEEKLY_QUESTS[Math.floor(Math.random() * WEEKLY_QUESTS.length)];
            this.user.weeklyQuest = quest.id;
            this.user.weeklyQuestWeek = currentWeek;
            this.user.weeklyProgress = 0;
            this.user.weeklyCompleted = false;
            await this.saveUser();
        }
    }
    
    async updateWeeklyProgress(type, amount = 1) {
        const quest = WEEKLY_QUESTS.find(q => q.id === this.user.weeklyQuest);
        if (!quest || this.user.weeklyCompleted) return;
        
        if (quest.type === type) {
            this.user.weeklyProgress = (this.user.weeklyProgress || 0) + amount;
            
            if (this.user.weeklyProgress >= quest.target) {
                this.user.weeklyCompleted = true;
                await this.addXP(quest.reward);
                this.toast(`WEEKLY QUEST COMPLETE! +${quest.reward} XP`);
                this.playSound(988, 0.15);
            }
            
            await this.saveUser();
        }
    }
    
    // ‚ïê‚ïê‚ïê EPIC QUEST SYSTEM ‚ïê‚ïê‚ïê
    getEpicProgress(questId) {
        const quest = EPIC_QUESTS.find(q => q.id === questId);
        if (!quest) return { current: 0, target: 0, percent: 0 };
        
        let current = 0;
        switch (questId) {
            case 'centurion': current = this.user.total || 0; break;
            case 'streak_master': current = this.user.streak || 0; break;
            case 'boss_legend': current = this.user.bossWins || 0; break;
            case 'max_level': current = this.user.level || 1; break;
        }
        
        return {
            current: Math.min(current, quest.target),
            target: quest.target,
            percent: Math.min(100, (current / quest.target) * 100)
        };
    }
    
    async checkEpicQuests() {
        if (!this.user.epicProgress) this.user.epicProgress = {};
        
        for (const quest of EPIC_QUESTS) {
            if (this.user.epicProgress[quest.id]) continue; // Already completed
            
            const progress = this.getEpicProgress(quest.id);
            if (progress.percent >= 100) {
                this.user.epicProgress[quest.id] = true;
                await this.addXP(quest.reward);
                this.toast(`üèÜ EPIC QUEST: ${quest.name}! +${quest.reward} XP`);
                this.playSound(1319, 0.2);
                await this.saveUser();
            }
        }
    }
    
    // ‚ïê‚ïê‚ïê LEADERBOARD SYSTEM ‚ïê‚ïê‚ïê
    getLeaderboard() {
        const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        
        // Generate NPC scores with daily variance
        const npcs = LEADERBOARD_NPC.map(npc => {
            const seed = (npc.name.charCodeAt(0) * dayOfYear) % 1000;
            const variance = (seed / 1000 - 0.5) * npc.variance * 2;
            let xp = Math.floor(npc.baseXP + variance);
            
            // Add progression over time
            if (npc.personality === 'aggressive') xp += dayOfYear * 15;
            else if (npc.personality === 'competitive') xp += dayOfYear * 12;
            else if (npc.personality === 'steady') xp += dayOfYear * 8;
            else if (npc.personality === 'elite') xp += dayOfYear * 20;
            else xp += dayOfYear * 5;
            
            return {
                name: npc.name,
                avatar: npc.avatar,
                xp: xp,
                level: Math.floor(xp / 100) + 1,
                isNPC: true
            };
        });
        
        // Add player
        const playerXP = this.user.totalXPEarned || (this.user.level - 1) * 100 + this.user.xp;
        const player = {
            name: 'YOU',
            avatar: 'üë§',
            xp: playerXP,
            level: this.user.level,
            isNPC: false
        };
        
        // Combine and sort
        const all = [...npcs, player].sort((a, b) => b.xp - a.xp);
        
        return all.map((entry, idx) => ({ ...entry, rank: idx + 1 }));
    }
    
    // ‚ïê‚ïê‚ïê BOSS MODE ‚ïê‚ïê‚ïê
    showBossModal(task) {
        this.showModal('‚ò† BOSS BATTLE', `
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="color: var(--accent); font-size: 11px; margin-bottom: 10px;">ENGAGE V-K PROTOCOL FOR:</div>
                <div style="font-size: 14px; padding: 10px; border: 1px solid var(--fg-dim);">${this.esc(task.text)}</div>
            </div>
            <div class="form-group">
                <label class="form-label">TIME LIMIT:</label>
                <div class="select-row">
                    <button class="select-btn ${this.selectedBossTime===15?'active':''}" onclick="App.setBossTime(15)">15 MIN</button>
                    <button class="select-btn ${this.selectedBossTime===25?'active':''}" onclick="App.setBossTime(25)">25 MIN</button>
                    <button class="select-btn ${this.selectedBossTime===45?'active':''}" onclick="App.setBossTime(45)">45 MIN</button>
                </div>
            </div>
            <div style="text-align: center; color: var(--warning); font-size: 10px; margin: 15px 0;">
                ‚òÖ WIN: X2 XP (${task.xp * 2} XP) ‚òÖ
            </div>
            <button class="btn-submit" style="border-color: var(--accent); color: var(--accent);" onclick="App.startBoss('${task.id}')">[ENTER] START BATTLE</button>
        `);
    }
    
    setBossTime(t) {
        this.selectedBossTime = t;
        document.querySelectorAll('.select-btn').forEach(b => {
            const v = parseInt(b.textContent);
            b.classList.toggle('active', v === t);
        });
    }
    
    async startBoss(id) {
        const task = await this.dbGet('tasks', id);
        if (!task) return;
        
        this.closeModal();
        this.bossActive = true;
        this.bossTask = task;
        this.bossDuration = this.selectedBossTime * 60;
        this.bossTimeLeft = this.bossDuration;
        
        document.getElementById('bossTask').textContent = task.text;
        document.getElementById('bossOverlay').classList.add('active');
        
        this.updateBossTimer();
        this.bossTimer = setInterval(() => {
            this.bossTimeLeft--;
            this.updateBossTimer();
            
            if (this.bossTimeLeft <= 0) {
                this.bossFail();
            }
        }, 1000);
        
        // Sound
        [440, 554, 659].forEach((f, i) => setTimeout(() => this.playSound(f, 0.1), i * 100));
    }
    
    updateBossTimer() {
        const mins = Math.floor(this.bossTimeLeft / 60);
        const secs = this.bossTimeLeft % 60;
        const timerEl = document.getElementById('bossTimer');
        const progressEl = document.getElementById('bossProgressFill');
        
        timerEl.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        
        const pct = (this.bossTimeLeft / this.bossDuration) * 100;
        progressEl.style.width = pct + '%';
        
        // Warning states
        if (pct <= 20) {
            timerEl.className = 'boss-timer danger';
            progressEl.className = 'boss-progress-fill danger';
        } else if (pct <= 50) {
            timerEl.className = 'boss-timer warning';
            progressEl.className = 'boss-progress-fill warning';
        } else {
            timerEl.className = 'boss-timer';
            progressEl.className = 'boss-progress-fill';
        }
    }
    
    async bossWin() {
        clearInterval(this.bossTimer);
        document.getElementById('bossOverlay').classList.remove('active');
        
        // Mark task done with x2 XP
        this.bossTask.done = true;
        this.bossTask.doneAt = new Date().toISOString();
        await this.dbPut('tasks', this.bossTask);
        
        const xpGain = this.bossTask.xp * 2;
        this.user.bossWins++;
        this.user.todayBossWins = (this.user.todayBossWins || 0) + 1;
        this.user.totalXPEarned = (this.user.totalXPEarned || 0) + xpGain;
        await this.addXP(xpGain);
        await this.updateStreak();
        await this.updateQuestProgress();
        
        // RPG: Combat stat +3
        await this.addStat('combat', 3);
        await this.updateWeeklyProgress('boss', 1);
        await this.checkEpicQuests();
        
        // Victory sound
        [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => this.playSound(f, 0.15), i * 100));
        
        this.toast(`‚ò† BOSS DEFEATED! +${xpGain} XP`);
        this.tasks = await this.dbAll('tasks');
        this.bossActive = false;
        this.bossTask = null;
        await this.saveUser();
        this.render();
    }
    
    bossFail() {
        clearInterval(this.bossTimer);
        document.getElementById('bossOverlay').classList.remove('active');
        
        // Fail sound
        [200, 150, 100].forEach((f, i) => setTimeout(() => this.playSound(f, 0.1), i * 150));
        
        this.toast('‚ò† BOSS BATTLE FAILED...', 'error');
        this.bossActive = false;
        this.bossTask = null;
    }
    
    async initBoss(id) {
        const task = await this.dbGet('tasks', id);
        if (task) this.showBossModal(task);
    }
    
    // ‚ïê‚ïê‚ïê TAGS ‚ïê‚ïê‚ïê
    async addTag() {
        this.showModal('NEW TAG', `
            <div class="form-group">
                <label class="form-label">TAG NAME:</label>
                <input type="text" class="input" id="tagInput" placeholder="E.G. WORK, PERSONAL...">
            </div>
            <div class="form-group">
                <label class="form-label">COLOR:</label>
                <div class="select-row">
                    <button class="select-btn" style="color: #00E5C4;" data-color="#00E5C4" onclick="App.setTagColor('#00E5C4')">CYAN</button>
                    <button class="select-btn active" style="color: #FF2E97;" data-color="#FF2E97" onclick="App.setTagColor('#FF2E97')">PINK</button>
                    <button class="select-btn" style="color: #FFAA00;" data-color="#FFAA00" onclick="App.setTagColor('#FFAA00')">AMBER</button>
                    <button class="select-btn" style="color: #00FF00;" data-color="#00FF00" onclick="App.setTagColor('#00FF00')">GREEN</button>
                </div>
            </div>
            <button class="btn-submit" onclick="App.saveTag()">[ENTER] CREATE</button>
        `);
        this.selectedTagColor = '#FF2E97';
    }
    
    setTagColor(c) {
        this.selectedTagColor = c;
        document.querySelectorAll('[data-color]').forEach(b => b.classList.toggle('active', b.dataset.color === c));
    }
    
    async saveTag() {
        const name = document.getElementById('tagInput').value.trim().toUpperCase();
        if (!name) { this.toast('ENTER TAG NAME', 'error'); return; }
        
        const tag = {
            id: 'tag_' + Date.now(),
            name: name,
            color: this.selectedTagColor
        };
        
        await this.dbPut('tags', tag);
        this.tags = await this.dbAll('tags');
        this.closeModal();
        this.toast('TAG CREATED: #' + name);
        this.render();
    }
    
    async delTag(id) {
        await this.dbDel('tags', id);
        this.tags = await this.dbAll('tags');
        this.toast('TAG DELETED');
        this.render();
    }
    
    toggleTag(id) {
        const idx = this.selectedTags.indexOf(id);
        if (idx === -1) this.selectedTags.push(id);
        else this.selectedTags.splice(idx, 1);
        
        document.querySelectorAll('.tag-select').forEach(t => {
            t.classList.toggle('selected', this.selectedTags.includes(t.dataset.tagid));
        });
    }
    
    setTagFilter(id) {
        this.filterTag = id;
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê HABITS ‚ïê‚ïê‚ïê
    async addHabit() {
        this.showModal('NEW HABIT', `
            <div class="form-group">
                <label class="form-label">HABIT NAME:</label>
                <input type="text" class="input" id="habitInput" placeholder="E.G. EXERCISE, MEDITATE...">
            </div>
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn" data-hxp="3" onclick="App.setHabitXP(3)">+3</button>
                    <button class="select-btn active" data-hxp="5" onclick="App.setHabitXP(5)">+5</button>
                    <button class="select-btn" data-hxp="10" onclick="App.setHabitXP(10)">+10</button>
                </div>
            </div>
            <button class="btn-submit" onclick="App.saveHabit()">[ENTER] CREATE</button>
        `);
        this.selectedHabitXP = 5;
    }
    
    setHabitXP(x) {
        this.selectedHabitXP = x;
        document.querySelectorAll('[data-hxp]').forEach(b => b.classList.toggle('active', parseInt(b.dataset.hxp) === x));
    }
    
    async saveHabit() {
        const name = document.getElementById('habitInput').value.trim();
        if (!name) { this.toast('ENTER HABIT NAME', 'error'); return; }
        
        const habit = {
            id: 'h_' + Date.now(),
            text: name,
            xp: this.selectedHabitXP,
            streak: 0,
            lastCompleted: null
        };
        
        await this.dbPut('habits', habit);
        this.habits = await this.dbAll('habits');
        this.closeModal();
        this.toast('HABIT CREATED');
        this.render();
    }
    
    async toggleHabit(id) {
        const habit = this.habits.find(h => h.id === id);
        if (!habit) return;
        
        const today = this.today();
        
        if (habit.lastCompleted === today) {
            // Undo
            habit.lastCompleted = null;
            habit.streak = Math.max(0, habit.streak - 1);
        } else {
            // Complete
            const yesterday = this.dateOffset(-1);
            if (habit.lastCompleted === yesterday || habit.streak === 0) {
                habit.streak++;
            } else {
                habit.streak = 1;
            }
            habit.lastCompleted = today;
            const xpGained = habit.xp;
            this.user.totalXPEarned = (this.user.totalXPEarned || 0) + xpGained;
            await this.addXP(xpGained);
            this.toast(`+${xpGained} XP - HABIT DONE!`);
            
            // RPG: Discipline stat
            await this.addStat('discipline', 1);
            
            // Check if all habits done for weekly quest
            const allHabits = this.habits.every(h => h.lastCompleted === today);
            if (allHabits) await this.updateWeeklyProgress('habits', 1);
        }
        
        await this.dbPut('habits', habit);
        this.habits = await this.dbAll('habits');
        await this.updateQuestProgress();
        await this.saveUser();
        this.render();
    }
    
    async delHabit(id) {
        await this.dbDel('habits', id);
        this.habits = await this.dbAll('habits');
        this.toast('HABIT DELETED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê SUBTASKS ‚ïê‚ïê‚ïê
    async addSubtask(taskId) {
        const input = document.getElementById('subtaskInput_' + taskId);
        if (!input) return;
        
        const text = input.value.trim();
        if (!text) return;
        
        const task = await this.dbGet('tasks', taskId);
        if (!task) return;
        
        if (!task.subtasks) task.subtasks = [];
        task.subtasks.push({ text, done: false });
        
        await this.dbPut('tasks', task);
        this.tasks = await this.dbAll('tasks');
        input.value = '';
        this.editTask(taskId);
    }
    
    async toggleSubtask(taskId, idx) {
        const task = await this.dbGet('tasks', taskId);
        if (!task || !task.subtasks || !task.subtasks[idx]) return;
        
        task.subtasks[idx].done = !task.subtasks[idx].done;
        await this.dbPut('tasks', task);
        this.tasks = await this.dbAll('tasks');
    }
    
    async delSubtask(taskId, idx) {
        const task = await this.dbGet('tasks', taskId);
        if (!task || !task.subtasks) return;
        
        task.subtasks.splice(idx, 1);
        await this.dbPut('tasks', task);
        this.tasks = await this.dbAll('tasks');
    }
    
    // ‚ïê‚ïê‚ïê SCHEDULED TASKS ‚ïê‚ïê‚ïê
    async addScheduled() {
        const tagsHTML = this.tags.map(t => `
            <span class="tag tag-select ${this.selectedTags.includes(t.id)?'selected':''}" 
                  data-tagid="${t.id}"
                  style="border-color: ${t.color}; color: ${this.selectedTags.includes(t.id)?'var(--bg)':t.color}; background: ${this.selectedTags.includes(t.id)?t.color:'transparent'};"
                  onclick="App.toggleTag('${t.id}')">#${t.name}</span>
        `).join('');
        
        this.showModal('SCHEDULED TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="schedInput" placeholder="ENTER TASK...">
            </div>
            <div class="form-group">
                <label class="form-label">SCHEDULED DATE:</label>
                <input type="date" class="input" id="schedDate" min="${this.dateOffset(1)}">
            </div>
            ${this.tags.length > 0 ? `<div class="form-group"><label class="form-label">TAGS:</label><div class="tags-row">${tagsHTML}</div></div>` : ''}
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn active" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">XP:</label>
                <div class="select-row">
                    <button class="select-btn" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn active" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn" data-xp="20" onclick="App.setXP(20)">+20</button>
                </div>
            </div>
            <button class="btn-submit" onclick="App.saveScheduled()">[ENTER] SCHEDULE</button>
        `);
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
    }
    
    async saveScheduled() {
        const text = document.getElementById('schedInput').value.trim();
        const date = document.getElementById('schedDate').value;
        if (!text) { this.toast('ENTER TASK', 'error'); return; }
        if (!date) { this.toast('SELECT DATE', 'error'); return; }
        
        const task = {
            id: 's_' + Date.now(),
            text: text,
            scheduledDate: date,
            priority: this.selectedPriority,
            xp: this.selectedXP,
            tags: [...this.selectedTags],
            subtasks: []
        };
        
        await this.dbPut('scheduled', task);
        this.scheduled = await this.dbAll('scheduled');
        this.closeModal();
        this.toast('TASK SCHEDULED: ' + date);
        this.render();
    }
    
    async delScheduled(id) {
        await this.dbDel('scheduled', id);
        this.scheduled = await this.dbAll('scheduled');
        this.toast('SCHEDULED TASK DELETED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê SOUND ‚ïê‚ïê‚ïê
    playSound(freq, dur) {
        try {
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            osc.type = 'square';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.06, this.audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + dur);
            osc.start();
            osc.stop(this.audioCtx.currentTime + dur);
        } catch (e) {}
    }
    
    // ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê
    go(tab) {
        this.tab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.tab === tab));
        this.triggerStatic();
        this.playSound(220, 0.05);
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
    render() {
        const c = document.getElementById('mainContent');
        if (this.tab === 'tasks') c.innerHTML = this.renderTasks();
        else if (this.tab === 'plan') c.innerHTML = this.renderPlan();
        else if (this.tab === 'stats') c.innerHTML = this.renderStats();
        else c.innerHTML = this.renderSys();
        
        // Update status bar
        this.updateStatusBar();
        this.renderStickers();
    }
    
    updateStatusBar() {
        const today = this.today();
        const active = this.tasks.filter(t => !t.done && (t.date === today || !t.date)).length;
        const done = this.tasks.filter(t => t.done && t.date === today).length;
        const overdue = this.tasks.filter(t => !t.done && t.date && t.date < today).length;
        
        const statusLeft = document.getElementById('statusLeft');
        const statusRight = document.getElementById('statusRight');
        
        if (statusLeft) {
            if (overdue > 0) {
                statusLeft.textContent = `‚ö† ${overdue} OVERDUE`;
                statusLeft.style.color = '';
            } else {
                statusLeft.textContent = 'READY';
                statusLeft.style.color = '';
            }
        }
        
        if (statusRight) {
            statusRight.textContent = `TASKS: ${active} | DONE: ${done}`;
        }
    }
    
    icon(name, cls = '') { return `<span class="mac-icon ${cls}">${ICONS[name] || ''}</span>`; }
    
    renderTasks() {
        const today = this.today();
        const overdue = this.tasks.filter(t => !t.done && t.date && t.date < today);
        const todayTasks = this.tasks.filter(t => t.date === today || (!t.date && !t.done));
        const active = this.filterTag 
            ? todayTasks.filter(t => !t.done && t.tags && t.tags.includes(this.filterTag))
            : todayTasks.filter(t => !t.done);
        const done = todayTasks.filter(t => t.done);
        const rank = RANKS[Math.min(this.user.level - 1, RANKS.length - 1)];
        
        // Daily Mission
        const mission = DAILY_MISSIONS.find(m => m.id === this.user.dailyMission);
        let missionHTML = '';
        if (mission) {
            const progress = this.user.dailyMissionProgress || 0;
            const completed = this.user.dailyMissionCompleted;
            const progressText = mission.type === 'overdue' || mission.type === 'habits' 
                ? (completed ? '‚úì' : '...')
                : `${progress}/${mission.target}`;
            
            missionHTML = `
                <div class="mission-box" style="${completed ? 'border-color:var(--fg);opacity:0.6;' : ''}">
                    <div class="mission-name" style="${completed ? 'text-decoration:line-through;' : ''}">${mission.name}</div>
                    <div class="mission-desc">${mission.desc}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                        <span class="mission-progress">${completed ? '‚úì COMPLETED' : `PROGRESS: ${progressText}`}</span>
                        <span class="mission-reward">${completed ? 'CLAIMED' : `+${mission.reward} XP`}</span>
                    </div>
                </div>`;
        }
        
        // Tag filter
        let tagFilterHTML = '';
        if (this.tags.length > 0) {
            tagFilterHTML = `
                <div class="tags-row" style="margin-bottom:12px;">
                    <span class="tag ${!this.filterTag?'selected':''}" onclick="App.setTagFilter(null)" style="border-color:var(--fg);">ALL</span>
                    ${this.tags.map(t => `
                        <span class="tag ${this.filterTag===t.id?'selected':''}" 
                              style="border-color:${t.color};color:${this.filterTag===t.id?'var(--bg)':t.color};background:${this.filterTag===t.id?t.color:'transparent'};"
                              onclick="App.setTagFilter('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>`;
        }
        
        let h = `
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>USER DOSSIER</span>
                </div>
                <div class="window-content">
                    <div style="display:flex;gap:15px;align-items:flex-start;">
                        <div class="dither-frame" style="width:56px;flex-shrink:0;cursor:pointer;" onclick="App.showAvatarModal()">
                            <div class="dither-frame-inner" style="height:56px;display:flex;align-items:center;justify-content:center;font-size:32px;">
                                ${this.getCurrentAvatar()}
                                <div class="dither-overlay"></div>
                            </div>
                        </div>
                        <div class="dossier-grid" style="flex:1;">
                            <span class="dossier-label">TITLE</span>
                            <span class="dossier-value" style="cursor:pointer;color:var(--cyan);" onclick="App.showTitleModal()">${this.getCurrentTitle()}</span>
                            <span class="dossier-label">CLEARANCE</span>
                            <span class="dossier-value">${rank}</span>
                            <span class="dossier-label">LEVEL</span>
                            <span class="dossier-value">${this.user.level}</span>
                            <span class="dossier-label">STREAK</span>
                            <span class="dossier-value" style="color:var(--warning);">üî• ${this.user.streak || 0}${this.user.streakShields ? ' üõ°Ô∏è' : ''}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STATS ROW -->
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value">${active.length}</div>
                    <div class="stat-label">TODO</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${done.length}</div>
                    <div class="stat-label">DONE</div>
                </div>
                <div class="stat-box ${overdue.length > 0 ? 'danger' : ''}">
                    <div class="stat-value">${overdue.length}</div>
                    <div class="stat-label">OVERDUE</div>
                </div>
            </div>
            
            ${missionHTML}`;
        
        // Overdue tasks
        if (overdue.length > 0) {
            h += `
                <div class="window" style="border-color: var(--accent);">
                    <div class="window-title-bar" style="background: linear-gradient(180deg, rgba(255,46,151,0.2) 0%, transparent 100%);">
                        <div class="window-close"></div>
                        <div class="window-title-stripes"></div>
                        <span style="color:var(--accent);">‚ö† OVERDUE [${overdue.length}]</span>
                    </div>
                    <div class="window-content">
                        ${overdue.map(t => this.renderTask(t, true)).join('')}
                    </div>
                </div>`;
        }
        
        // Habits - CYAN BORDER
        if (this.habits.length > 0) {
            h += `
                <div class="window habits-window">
                    <div class="window-title-bar">
                        <div class="window-close"></div>
                        <div class="window-title-stripes"></div>
                        <span>DAILY HABITS</span>
                    </div>
                    <div class="window-content">
                        ${this.habits.map(hb => {
                            const doneToday = hb.lastCompleted === today;
                            return `
                                <div class="habit-item">
                                    <button class="habit-check ${doneToday?'done':''}" onclick="App.toggleHabit('${hb.id}')">
                                        ${doneToday ? '‚úì' : ''}
                                    </button>
                                    <div class="habit-content" onclick="App.editHabit('${hb.id}')">
                                        <div class="habit-name">${this.esc(hb.text)}</div>
                                        <div class="habit-meta">
                                            <span class="habit-streak">üî• ${hb.streak}</span>
                                            <span>+${hb.xp} XP</span>
                                        </div>
                                    </div>
                                </div>`;
                        }).join('')}
                        <button class="btn btn-block" onclick="App.addHabit()" style="margin-top:10px;font-size:10px;">+ ADD HABIT</button>
                    </div>
                </div>`;
        }
        
        // Active tasks
        h += `
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>ACTIVE TASKS [${active.length}]</span>
                </div>
                <div class="window-content">
                    ${tagFilterHTML}
                    <button class="btn btn-block" onclick="App.showAddTask()" style="margin-bottom:15px;">+ NEW TASK</button>`;
        
        if (!active.length) {
            h += `<div class="empty-state">
                <div class="empty-icon">${this.icon('folder', 'mac-icon-lg')}</div>
                <div class="empty-title">NO ACTIVE TASKS</div>
                <div class="empty-text">Add a new task to begin</div>
            </div>`;
        } else {
            h += active.sort((a,b) => {
                const ord = {high:0,medium:1,low:2};
                return (ord[a.priority]||1) - (ord[b.priority]||1);
            }).map(t => this.renderTask(t)).join('');
        }
        h += `</div></div>`;
        
        // Link to scheduled tasks
        if (this.scheduled.length > 0) {
            h += `<div style="text-align:center;padding:10px;font-size:10px;">
                <span onclick="App.go('plan')" style="cursor:pointer;color:var(--fg-dim);text-decoration:underline;">
                    üìÖ ${this.scheduled.length} scheduled tasks ‚Üí View PLAN tab
                </span>
            </div>`;
        }
        
        // Completed today
        if (done.length) {
            h += `<div class="window" style="opacity:0.5">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>COMPLETED TODAY [${done.length}]</span>
                </div>
                <div class="window-content">
                    ${done.slice(0, 3).map(t => this.renderTask(t)).join('')}
                    ${done.length > 3 ? `<div style="text-align:center;font-size:10px;color:var(--fg-dim);padding:12px;">+${done.length - 3} MORE</div>` : ''}
                </div>
            </div>`;
        }
        
        // Add habit button if no habits
        if (this.habits.length === 0) {
            h += `<button class="btn btn-block" onclick="App.addHabit()" style="margin-top:10px;">+ ADD DAILY HABIT</button>`;
        }
        
        // Add tag button
        h += `<button class="btn btn-block" onclick="App.addTag()" style="margin-top:10px;font-size:10px;">+ MANAGE TAGS</button>`;
        
        return h;
    }
    
    renderTask(t, isOverdue = false) {
        const today = this.today();
        let status = 'active', icon = 'document';
        
        if (t.done) { status = 'done'; icon = 'documentDone'; }
        else if (t.priority === 'high') { status = 'urgent'; icon = 'warning'; }
        else if (isOverdue || (t.date && t.date < today)) { status = 'overdue'; }
        
        const labels = { active: 'ACTIVE', overdue: 'OVERDUE', urgent: 'URGENT', done: 'DONE' };
        
        // Tags
        let tagsHTML = '';
        if (t.tags && t.tags.length > 0) {
            tagsHTML = t.tags.map(tid => {
                const tag = this.tags.find(tg => tg.id === tid);
                return tag ? `<span class="tag-inline" style="color:${tag.color};">#${tag.name}</span>` : '';
            }).join('');
        }
        
        // Subtasks progress
        let subtasksHTML = '';
        if (t.subtasks && t.subtasks.length > 0) {
            const doneCount = t.subtasks.filter(s => s.done).length;
            subtasksHTML = `<span style="color:var(--warning);">[${doneCount}/${t.subtasks.length}]</span>`;
        }
        
        // Deadline badge
        let deadlineHTML = '';
        if (t.deadline && !t.done) {
            const deadline = new Date(t.deadline);
            const now = new Date();
            const diff = deadline - now;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            
            if (diff < 0) {
                deadlineHTML = `<span style="color:var(--accent);font-size:9px;">‚è∞ OVERDUE</span>`;
            } else if (minutes < 60) {
                deadlineHTML = `<span style="color:var(--accent);font-size:9px;animation:blink 0.5s infinite;">‚è∞ ${minutes}M LEFT</span>`;
            } else if (hours < 24) {
                deadlineHTML = `<span style="color:var(--warning);font-size:9px;">‚è∞ ${hours}H LEFT</span>`;
            } else {
                const time = deadline.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
                deadlineHTML = `<span style="color:var(--fg-dim);font-size:9px;">‚è∞ ${time}</span>`;
            }
        }
        
        // Inline checkbox
        const checkbox = `<button class="task-checkbox ${t.done ? 'checked' : ''}" onclick="event.stopPropagation();App.quickToggle('${t.id}')">${t.done ? '‚úì' : ''}</button>`;
        
        // Boss button
        const bossBtn = !t.done ? `<button class="btn" style="font-size:9px;padding:6px 8px;color:var(--accent);border-color:var(--accent);" onclick="event.stopPropagation();App.initBoss('${t.id}')" title="Boss Battle">‚ò†</button>` : '';
        
        return `
            <div class="task-item ${t.done ? 'completed' : ''}">
                <div class="task-header" onclick="App.showTask('${t.id}')">
                    <span class="task-id">${tagsHTML}</span>
                    <span class="task-status ${status}">${labels[status]}</span>
                </div>
                <div class="task-body">
                    ${checkbox}
                    <div class="task-info" onclick="App.showTask('${t.id}')" style="cursor:pointer;flex:1;">
                        <div class="task-title" style="${t.done ? 'text-decoration:line-through;opacity:0.6;' : ''}">${this.esc(t.title || t.text)}</div>
                        <div class="task-meta">
                            <span>‚óÜ ${(t.priority || 'LOW').toUpperCase()}</span>
                            ${deadlineHTML}
                            ${subtasksHTML}
                            <span class="task-xp">+${t.xp || 10} XP</span>
                        </div>
                    </div>
                    ${bossBtn}
                </div>
            </div>`;
    }
    
    // ‚ïê‚ïê‚ïê PLAN TAB ‚ïê‚ïê‚ïê
    renderPlan() {
        const tomorrow = this.getTomorrow();
        const weekEnd = this.getWeekEnd();
        
        // Filter scheduled tasks
        let planned = this.filterTag 
            ? this.scheduled.filter(t => t.tags && t.tags.includes(this.filterTag))
            : [...this.scheduled];
        
        // Sort by date
        planned.sort((a, b) => a.scheduledDate.localeCompare(b.scheduledDate));
        
        // Group tasks
        const tomorrowTasks = planned.filter(t => t.scheduledDate === tomorrow);
        const weekTasks = planned.filter(t => t.scheduledDate > tomorrow && t.scheduledDate <= weekEnd);
        const laterTasks = planned.filter(t => t.scheduledDate > weekEnd);
        
        // Tag filter
        let tagFilterHTML = '';
        if (this.tags.length > 0) {
            tagFilterHTML = `
                <div class="tags-row" style="margin-bottom:12px;">
                    <span class="tag ${!this.filterTag?'selected':''}" onclick="App.setTagFilter(null)" style="border-color:var(--fg);">ALL</span>
                    ${this.tags.map(t => `
                        <span class="tag ${this.filterTag===t.id?'selected':''}" 
                              style="border-color:${t.color};color:${this.filterTag===t.id?'var(--bg)':t.color};background:${this.filterTag===t.id?t.color:'transparent'};"
                              onclick="App.setTagFilter('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>`;
        }
        
        let h = `
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>MISSION PLANNING</span>
                </div>
                <div class="window-content">
                    <div class="stats-row">
                        <div class="stat-box"><div class="stat-value">${tomorrowTasks.length}</div><div class="stat-label">TOMORROW</div></div>
                        <div class="stat-box"><div class="stat-value">${weekTasks.length}</div><div class="stat-label">THIS WEEK</div></div>
                        <div class="stat-box"><div class="stat-value">${laterTasks.length}</div><div class="stat-label">LATER</div></div>
                    </div>
                </div>
            </div>
            
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>üìÖ SCHEDULED TASKS [${planned.length}]</span>
                </div>
                <div class="window-content">
                    ${tagFilterHTML}
                    <button class="btn btn-block" onclick="App.addScheduled()" style="margin-bottom:15px;">+ SCHEDULE NEW TASK</button>`;
        
        if (planned.length === 0) {
            h += `<div class="empty-state">
                <div class="empty-icon">${this.icon('folder', 'mac-icon-lg')}</div>
                <div class="empty-title">NO PLANNED TASKS</div>
                <div class="empty-text">Schedule your future missions</div>
            </div>`;
        } else {
            // Tomorrow
            if (tomorrowTasks.length > 0) {
                h += `<div style="font-size:10px;color:var(--warning);margin:15px 0 8px;border-bottom:1px solid var(--fg-dark);padding-bottom:6px;">
                    ‚ñ∫ TOMORROW (${this.formatDate(tomorrow)})
                </div>`;
                h += tomorrowTasks.map(t => this.renderPlanTask(t)).join('');
            }
            
            // This Week
            if (weekTasks.length > 0) {
                h += `<div style="font-size:10px;color:var(--fg);margin:15px 0 8px;border-bottom:1px solid var(--fg-dark);padding-bottom:6px;">
                    ‚ñ∫ THIS WEEK
                </div>`;
                h += weekTasks.map(t => this.renderPlanTask(t)).join('');
            }
            
            // Later
            if (laterTasks.length > 0) {
                h += `<div style="font-size:10px;color:var(--fg-dim);margin:15px 0 8px;border-bottom:1px solid var(--fg-dark);padding-bottom:6px;">
                    ‚ñ∫ LATER
                </div>`;
                h += laterTasks.map(t => this.renderPlanTask(t)).join('');
            }
        }
        
        h += `</div></div>`;
        return h;
    }
    
    renderPlanTask(t) {
        // Tags
        let tagsHTML = '';
        if (t.tags && t.tags.length > 0) {
            tagsHTML = t.tags.map(tid => {
                const tag = this.tags.find(tg => tg.id === tid);
                return tag ? `<span class="tag-inline" style="color:${tag.color};">#${tag.name}</span>` : '';
            }).join('');
        }
        
        return `
            <div class="task-item" onclick="App.editPlanTask('${t.id}')">
                <div class="task-header">
                    <span class="task-id">${this.formatDate(t.scheduledDate)} ${tagsHTML}</span>
                    <span class="task-status">${(t.priority||'MED').toUpperCase()}</span>
                </div>
                <div class="task-body">
                    <div class="task-icon">${this.icon('document', 'mac-icon-sm')}</div>
                    <div class="task-info">
                        <div class="task-title">${this.esc(t.text)}</div>
                        <div class="task-meta">
                            <span>+${t.xp} XP</span>
                            ${t.subtasks && t.subtasks.length > 0 ? `<span style="color:var(--warning);">[${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length}]</span>` : ''}
                        </div>
                    </div>
                    <button class="btn" style="font-size:9px;padding:6px 8px;" onclick="event.stopPropagation();App.delScheduled('${t.id}')">[X]</button>
                </div>
            </div>`;
    }
    
    async editPlanTask(id) {
        const task = this.scheduled.find(t => t.id === id);
        if (!task) return;
        
        this.selectedPriority = task.priority || 'medium';
        this.selectedXP = task.xp || 10;
        this.selectedTags = task.tags ? [...task.tags] : [];
        
        const tagsHTML = this.tags.length > 0 ? `
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row">
                    ${this.tags.map(t => `
                        <span class="tag tag-select ${this.selectedTags.includes(t.id)?'selected':''}" data-tagid="${t.id}"
                              style="border-color:${t.color};color:${this.selectedTags.includes(t.id)?'var(--bg)':t.color};background:${this.selectedTags.includes(t.id)?t.color:'transparent'};"
                              onclick="App.toggleTag('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>
            </div>` : '';
        
        this.showModal('EDIT SCHEDULED TASK', `
            <div class="form-group">
                <label class="form-label">DESCRIPTION:</label>
                <input type="text" class="input" id="editPlanInput" value="${this.esc(task.text)}">
            </div>
            <div class="form-group">
                <label class="form-label">SCHEDULED DATE:</label>
                <input type="date" class="input" id="editPlanDate" value="${task.scheduledDate}" min="${this.today()}">
            </div>
            ${tagsHTML}
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn ${this.selectedPriority==='low'?'active':''}" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn ${this.selectedPriority==='medium'?'active':''}" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn ${this.selectedPriority==='high'?'active':''}" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">XP:</label>
                <div class="select-row">
                    <button class="select-btn ${this.selectedXP===5?'active':''}" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn ${this.selectedXP===10?'active':''}" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn ${this.selectedXP===20?'active':''}" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn ${this.selectedXP===50?'active':''}" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            <button class="btn btn-block" style="margin-bottom:12px;" onclick="App.updatePlanTask('${id}')">[SAVE]</button>
            <button class="btn btn-danger btn-block" onclick="App.delScheduled('${id}')">[DELETE]</button>
        `);
    }
    
    async updatePlanTask(id) {
        const task = this.scheduled.find(t => t.id === id);
        if (!task) return;
        
        const text = document.getElementById('editPlanInput').value.trim();
        const date = document.getElementById('editPlanDate').value;
        if (!text) { this.toast('ENTER TASK', 'error'); return; }
        if (!date) { this.toast('SELECT DATE', 'error'); return; }
        
        task.text = text;
        task.scheduledDate = date;
        task.priority = this.selectedPriority;
        task.xp = this.selectedXP;
        task.tags = [...this.selectedTags];
        
        await this.dbPut('scheduled', task);
        this.scheduled = await this.dbAll('scheduled');
        this.closeModal();
        this.toast('TASK UPDATED');
        this.render();
    }
    
    // Helper functions
    getTomorrow() {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
    }
    
    getWeekEnd() {
        const d = new Date();
        const day = d.getDay();
        const diff = 7 - day; // Days until Sunday
        d.setDate(d.getDate() + diff);
        return d.toISOString().split('T')[0];
    }
    
    formatDate(dateStr) {
        const d = new Date(dateStr);
        const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
        const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
        return `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
    }
    
    renderStats() {
        const done = this.tasks.filter(t => t.done);
        const pend = this.tasks.filter(t => !t.done).length;
        const rank = RANKS[Math.min(this.user.level - 1, RANKS.length - 1)];
        const userAch = this.user.achievements || [];
        
        // Calculate weekly XP
        const weeklyData = this.calcWeeklyXP(done);
        
        // Get RPG data
        const stats = this.user.stats || { focus: 0, endurance: 0, combat: 0, discipline: 0, speed: 0 };
        const weeklyQuest = WEEKLY_QUESTS.find(q => q.id === this.user.weeklyQuest);
        const leaderboard = this.getLeaderboard();
        
        // Character Stats HTML
        const statsHTML = CHARACTER_STATS.map(s => `
            <div class="stat-item">
                <div class="stat-icon" style="color:${s.color}">${s.icon}</div>
                <div class="stat-value">${this.getStatLevel(stats[s.id] || 0)}</div>
                <div class="stat-name">${s.name}</div>
            </div>
        `).join('');
        
        // Weekly Quest HTML
        let weeklyHTML = '';
        if (weeklyQuest) {
            const progress = this.user.weeklyProgress || 0;
            const percent = Math.min(100, (progress / weeklyQuest.target) * 100);
            weeklyHTML = `
                <div class="quest-panel weekly ${this.user.weeklyCompleted ? 'completed' : ''}">
                    <div class="quest-header">
                        <span class="quest-type">WEEKLY QUEST</span>
                        <span class="quest-reward">${this.user.weeklyCompleted ? '‚úì CLAIMED' : `+${weeklyQuest.reward} XP`}</span>
                    </div>
                    <div class="quest-name">${weeklyQuest.name}</div>
                    <div class="quest-desc">${weeklyQuest.desc}</div>
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width:${percent}%"></div>
                    </div>
                    <div class="quest-progress-text">${progress}/${weeklyQuest.target}</div>
                </div>
            `;
        }
        
        // Epic Quests HTML
        const epicHTML = EPIC_QUESTS.map(quest => {
            const prog = this.getEpicProgress(quest.id);
            const completed = this.user.epicProgress && this.user.epicProgress[quest.id];
            return `
                <div class="quest-panel epic ${completed ? 'completed' : ''}" style="opacity:${completed ? '0.6' : '1'}">
                    <div class="quest-header">
                        <span class="quest-type">${quest.icon} EPIC</span>
                        <span class="quest-reward">${completed ? '‚úì CLAIMED' : `+${quest.reward} XP`}</span>
                    </div>
                    <div class="quest-name">${quest.name}</div>
                    <div class="quest-desc">${quest.desc}</div>
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width:${prog.percent}%"></div>
                    </div>
                    <div class="quest-progress-text">${prog.current}/${prog.target}</div>
                </div>
            `;
        }).join('');
        
        // Leaderboard HTML
        const lbHTML = leaderboard.slice(0, 9).map(entry => {
            const rankClass = entry.rank === 1 ? 'gold' : entry.rank === 2 ? 'silver' : entry.rank === 3 ? 'bronze' : '';
            return `
                <div class="leaderboard-row ${entry.isNPC ? '' : 'you'}">
                    <span class="lb-rank ${rankClass}">#${entry.rank}</span>
                    <span class="lb-avatar">${entry.avatar}</span>
                    <span class="lb-name">${entry.name}</span>
                    <span class="lb-xp">${entry.xp.toLocaleString()} XP</span>
                    <span class="lb-level">LV.${entry.level}</span>
                </div>
            `;
        }).join('');
        
        return `
            <!-- CHARACTER STATS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:var(--cyan);">‚¨° CHARACTER STATS</span>
                </div>
                <div class="window-content">
                    <div class="stats-panel">${statsHTML}</div>
                    <div style="font-size:8px;color:var(--fg-dim);text-align:center;">
                        Complete tasks to level up your stats!
                    </div>
                </div>
            </div>
            
            <!-- QUESTS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:#00BFFF;">‚öë ACTIVE QUESTS</span>
                </div>
                <div class="window-content">
                    ${weeklyHTML}
                    ${epicHTML}
                </div>
            </div>
            
            <!-- LEADERBOARD -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:#FFD700;">üèÜ LEADERBOARD</span>
                </div>
                <div class="window-content" style="padding:0;">
                    <div class="leaderboard">
                        <div class="leaderboard-header">
                            <span>GLOBAL RANKING</span>
                            <span>SEASON 1</span>
                        </div>
                        ${lbHTML}
                    </div>
                </div>
            </div>
            
            <!-- STATISTICS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>STATISTICS</span>
                </div>
                <div class="window-content">
                    <div class="stats-row">
                        <div class="stat-box"><div class="stat-value">${this.tasks.length}</div><div class="stat-label">TOTAL</div></div>
                        <div class="stat-box"><div class="stat-value">${done.length}</div><div class="stat-label">DONE</div></div>
                        <div class="stat-box"><div class="stat-value">${pend}</div><div class="stat-label">PENDING</div></div>
                    </div>
                    <div class="dossier-grid" style="margin-top:12px;">
                        <span class="dossier-label">RANK</span>
                        <span class="dossier-value">${rank}</span>
                        <span class="dossier-label">STREAK</span>
                        <span class="dossier-value" style="color:var(--warning)">üî• ${this.user.streak || 0} DAYS</span>
                        <span class="dossier-label">BOSS WINS</span>
                        <span class="dossier-value" style="color:var(--accent)">‚ò† ${this.user.bossWins || 0}</span>
                    </div>
                </div>
            </div>
            
            <!-- XP CHART -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:var(--accent);">üìà LAST 7 DAYS XP</span>
                </div>
                <div class="window-content">
                    <pre style="font-family:'Share Tech Mono',monospace;font-size:9px;line-height:1.5;color:var(--fg);margin:0;">${weeklyData.ascii}</pre>
                    <div style="font-size:9px;color:var(--fg-dim);margin-top:8px;">
                        TOTAL: <span style="color:var(--warning);">${weeklyData.total} XP</span> | AVG: <span style="color:var(--fg);">${weeklyData.avg} XP/DAY</span>
                    </div>
                </div>
            </div>
            
            <!-- ACHIEVEMENTS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>ACHIEVEMENTS [${userAch.length}/${ACHIEVEMENTS.length}]</span>
                </div>
                <div class="window-content" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                    ${ACHIEVEMENTS.map(a => `
                        <div style="text-align:center;padding:10px 6px;border:1px solid ${userAch.includes(a.id) ? 'var(--warning)' : 'var(--fg-dark)'};opacity:${userAch.includes(a.id) ? '1' : '0.3'};background:${userAch.includes(a.id) ? 'rgba(255,184,0,0.1)' : 'transparent'}">
                            <div style="font-size:20px;color:${userAch.includes(a.id) ? 'var(--warning)' : 'var(--fg-dim)'};text-shadow:${userAch.includes(a.id) ? '0 0 15px var(--warning)' : 'none'}">${a.icon}</div>
                            <div style="font-size:7px;margin-top:4px;">${a.name}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- SECRET ACHIEVEMENTS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:#DDA0DD;">üîÆ SECRET [${(this.user.secretAchievements || []).length}/${SECRET_ACHIEVEMENTS.length}]</span>
                </div>
                <div class="window-content" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
                    ${SECRET_ACHIEVEMENTS.map(a => {
                        const unlocked = (this.user.secretAchievements || []).includes(a.id);
                        return `
                            <div style="text-align:center;padding:8px;border:1px solid ${unlocked ? '#DDA0DD' : 'var(--fg-dark)'};opacity:${unlocked ? '1' : '0.4'};background:${unlocked ? 'rgba(221,160,221,0.1)' : 'transparent'}">
                                <div style="font-size:18px;">${unlocked ? a.icon : '‚ùì'}</div>
                                <div style="font-size:6px;margin-top:3px;color:${unlocked ? '#DDA0DD' : 'var(--fg-dim)'};">${unlocked ? a.revealName : '???'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <!-- CUSTOM QUESTS -->
            ${this.customQuests.length > 0 ? `
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:var(--cyan);">‚öë MY QUESTS</span>
                </div>
                <div class="window-content">
                    ${this.customQuests.map(q => {
                        const percent = Math.min(100, (q.progress / q.target) * 100);
                        return `
                            <div class="custom-quest" style="opacity:${q.completed ? '0.6' : '1'}">
                                <div class="quest-header">
                                    <span class="quest-type">CUSTOM</span>
                                    <span class="quest-reward">${q.completed ? '‚úì DONE' : `+${q.reward} XP`}</span>
                                </div>
                                <div class="quest-name">${this.esc(q.name)}</div>
                                <div class="quest-desc">${this.esc(q.desc)}</div>
                                <div class="quest-progress-bar">
                                    <div class="quest-progress-fill" style="width:${percent}%;background:var(--cyan);"></div>
                                </div>
                                <div class="quest-progress-text">${q.progress}/${q.target}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>` : ''}`;
    }
    
    calcWeeklyXP(tasks) {
        const data = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const dayName = ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()];
            const dayTasks = tasks.filter(t => t.date === dateStr);
            const xp = dayTasks.reduce((sum, t) => sum + (t.xp || 10), 0);
            data.push({ day: dayName, xp });
        }
        
        const max = Math.max(...data.map(d => d.xp), 1);
        const total = data.reduce((a, b) => a + b.xp, 0);
        const avg = Math.round(total / 7);
        
        let ascii = '';
        data.forEach(d => {
            const barLen = Math.round((d.xp / max) * 20);
            const bar = '‚ñà'.repeat(barLen) + '‚ñë'.repeat(20 - barLen);
            ascii += `${d.day} [${bar}] ${d.xp}\n`;
        });
        
        return { ascii: ascii.trim(), total, avg };
    }
    
    calcHeatmap(tasks) {
        const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
        const counts = [0,0,0,0,0,0,0];
        
        tasks.forEach(t => {
            if (t.date) {
                const d = new Date(t.date);
                counts[d.getDay()]++;
            }
        });
        
        const max = Math.max(...counts, 1);
        let bestDay = 'N/A', bestCount = 0;
        
        let ascii = '';
        days.forEach((day, i) => {
            const count = counts[i];
            const barLen = Math.round((count / max) * 20);
            const bar = '‚ñà'.repeat(barLen) + '‚ñë'.repeat(20 - barLen);
            ascii += `${day} [${bar}] ${count}\n`;
            if (count > bestCount) { bestCount = count; bestDay = day; }
        });
        
        return { ascii: ascii.trim(), bestDay, bestCount };
    }
    
    calcMonthlyXP(tasks) {
        const xpByDay = [];
        for (let i = 29; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const dayTasks = tasks.filter(t => t.date === dateStr);
            const xp = dayTasks.reduce((sum, t) => sum + (t.xp || 10), 0);
            xpByDay.push(xp);
        }
        
        const max = Math.max(...xpByDay, 1);
        const total = xpByDay.reduce((a, b) => a + b, 0);
        const avg = Math.round(total / 30);
        
        // Sparkline
        const chars = ['¬∑','‚ñÅ','‚ñÇ','‚ñÉ','‚ñÑ','‚ñÖ','‚ñÜ','‚ñá','‚ñà'];
        const ascii = xpByDay.map(xp => {
            const idx = Math.round((xp / max) * (chars.length - 1));
            return chars[idx];
        }).join('');
        
        return { ascii, total, avg };
    }
    
    renderSys() {
        const th = this.user.theme || 'green';
        const mysteryAvailable = this.checkMysteryBox();
        
        return `
            <!-- PROFILE -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:var(--cyan);">üë§ PROFILE</span>
                </div>
                <div class="window-content">
                    <div class="list-menu">
                        <div class="list-menu-item" onclick="App.showAvatarModal()">
                            <div class="list-menu-icon" style="font-size:20px;">${this.getCurrentAvatar()}</div>
                            <div class="list-menu-content"><div class="list-menu-title">AVATAR</div><div class="list-menu-subtitle">Change your character</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.showTitleModal()">
                            <div class="list-menu-icon">üè∑Ô∏è</div>
                            <div class="list-menu-content"><div class="list-menu-title">TITLE</div><div class="list-menu-subtitle">${this.getCurrentTitle()}</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.showStickersModal()">
                            <div class="list-menu-icon">üìå</div>
                            <div class="list-menu-content"><div class="list-menu-title">STICKERS</div><div class="list-menu-subtitle">Manage your collection</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- REWARDS -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:#FFD700;">üéÅ REWARDS</span>
                </div>
                <div class="window-content">
                    <div class="list-menu">
                        <div class="list-menu-item ${mysteryAvailable ? '' : 'disabled'}" onclick="${mysteryAvailable ? 'App.showMysteryBoxModal()' : ''}">
                            <div class="list-menu-icon">${mysteryAvailable ? 'üéÅ' : 'üì¶'}</div>
                            <div class="list-menu-content">
                                <div class="list-menu-title" ${mysteryAvailable ? 'style="color:var(--warning);"' : ''}>MYSTERY BOX</div>
                                <div class="list-menu-subtitle">${mysteryAvailable ? 'Weekly reward ready!' : 'Claimed this week'}</div>
                            </div>
                            <span class="list-menu-arrow">${mysteryAvailable ? '‚ú®' : ''}</span>
                        </div>
                        <div class="list-menu-item" onclick="App.showCreateQuestModal()">
                            <div class="list-menu-icon">‚öë</div>
                            <div class="list-menu-content"><div class="list-menu-title">CREATE QUEST</div><div class="list-menu-subtitle">Make your own challenge</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.showGratitudeModal()">
                            <div class="list-menu-icon">üôè</div>
                            <div class="list-menu-content"><div class="list-menu-title">GRATITUDE JOURNAL</div><div class="list-menu-subtitle">Streak: ${this.user.gratitudeStreak || 0} days</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- POWERUPS -->
            ${this.user.streakShields || this.user.xpBoostCount ? `
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span style="color:var(--accent);">‚ö° POWERUPS</span>
                </div>
                <div class="window-content">
                    <div style="display:flex;gap:15px;justify-content:center;">
                        ${this.user.streakShields ? `<div style="text-align:center;padding:10px;border:1px solid var(--fg-dim);">
                            <div style="font-size:24px;">üõ°Ô∏è</div>
                            <div style="font-size:10px;color:var(--fg-dim);margin-top:5px;">STREAK SHIELD</div>
                            <div style="font-size:14px;color:var(--fg);">x${this.user.streakShields}</div>
                        </div>` : ''}
                        ${this.user.xpBoostCount ? `<div style="text-align:center;padding:10px;border:1px solid var(--warning);">
                            <div style="font-size:24px;">üöÄ</div>
                            <div style="font-size:10px;color:var(--fg-dim);margin-top:5px;">XP BOOST x2</div>
                            <div style="font-size:14px;color:var(--warning);">${this.user.xpBoostCount} tasks left</div>
                        </div>` : ''}
                    </div>
                </div>
            </div>` : ''}
            
            <!-- DISPLAY -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>DISPLAY</span>
                </div>
                <div class="window-content">
                    <div style="font-size:10px;color:var(--fg-dim);margin-bottom:10px;letter-spacing:2px;">TERMINAL COLOR:</div>
                    <div class="theme-selector">
                        <button class="theme-btn theme-btn-green ${th === 'green' ? 'active' : ''}" onclick="App.setTheme('green')"></button>
                        <button class="theme-btn theme-btn-purple ${th === 'purple' ? 'active' : ''}" onclick="App.setTheme('purple')"></button>
                        <button class="theme-btn theme-btn-amber ${th === 'amber' ? 'active' : ''}" onclick="App.setTheme('amber')"></button>
                    </div>
                </div>
            </div>
            
            <!-- SYSTEM -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>SYSTEM</span>
                </div>
                <div class="window-content">
                    <div class="list-menu">
                        <div class="list-menu-item" onclick="App.exportData()">
                            <div class="list-menu-icon">${this.icon('upload', 'mac-icon-sm')}</div>
                            <div class="list-menu-content"><div class="list-menu-title">EXPORT DATA</div><div class="list-menu-subtitle">Download backup</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.importData()">
                            <div class="list-menu-icon">${this.icon('download', 'mac-icon-sm')}</div>
                            <div class="list-menu-content"><div class="list-menu-title">IMPORT DATA</div><div class="list-menu-subtitle">Restore backup</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.clearDone()">
                            <div class="list-menu-icon">${this.icon('trash', 'mac-icon-sm')}</div>
                            <div class="list-menu-content"><div class="list-menu-title">CLEAR COMPLETED</div><div class="list-menu-subtitle">Remove done tasks</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                        <div class="list-menu-item" onclick="App.resetAll()">
                            <div class="list-menu-icon" style="color:var(--danger)">${this.icon('warning', 'mac-icon-sm')}</div>
                            <div class="list-menu-content"><div class="list-menu-title" style="color:var(--danger)">SYSTEM RESET</div><div class="list-menu-subtitle">Erase all data</div></div>
                            <span class="list-menu-arrow">‚ñ∂</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ABOUT -->
            <div class="window">
                <div class="window-title-bar">
                    <div class="window-close"></div>
                    <div class="window-title-stripes"></div>
                    <span>ABOUT</span>
                </div>
                <div class="window-content">
                    <div style="display:flex;gap:15px;align-items:flex-start;">
                        <div class="dither-frame" style="width:48px;flex-shrink:0;">
                            <div class="dither-frame-inner" style="height:48px;">
                                ${this.icon('disk', 'mac-icon-lg')}
                                <div class="dither-overlay"></div>
                            </div>
                        </div>
                        <div class="dossier-grid" style="flex:1;">
                            <span class="dossier-label">SYSTEM</span>
                            <span class="dossier-value">NEXUS</span>
                            <span class="dossier-label">VERSION</span>
                            <span class="dossier-value">6.0.0</span>
                            <span class="dossier-label">BUILD</span>
                            <span class="dossier-value">OCTALYSIS</span>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:20px;font-size:10px;color:var(--fg-dim);letter-spacing:2px;">
                        TYRELL CORPORATION<br>
                        <span style="color:var(--accent)">"MORE HUMAN THAN HUMAN"</span>
                    </div>
                </div>
            </div>`;
    }
    
    // ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
    showModal(title, body) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = body;
        document.getElementById('modalOverlay').classList.add('active');
        this.playSound(330, 0.05);
    }
    
    closeModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('modalOverlay').classList.remove('active');
    }
    
    showAddTask() {
        this.selectedPriority = 'medium';
        this.selectedXP = 10;
        this.selectedTags = [];
        
        const tagsHTML = this.tags.length > 0 ? `
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row">
                    ${this.tags.map(t => `
                        <span class="tag tag-select" data-tagid="${t.id}"
                              style="border-color:${t.color};color:${t.color};"
                              onclick="App.toggleTag('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>
            </div>` : '';
        
        this.showModal('NEW TASK', `
            <div class="form-group">
                <label class="form-label">DESIGNATION:</label>
                <input type="text" class="input" id="taskTitle" placeholder="Enter task...">
            </div>
            <div class="form-group">
                <label class="form-label">TARGET DATE:</label>
                <input type="date" class="input" id="taskDate" value="${this.today()}">
            </div>
            <div class="form-group">
                <label class="form-label">DEADLINE TIME (OPTIONAL):</label>
                <input type="time" class="input" id="taskDeadline" placeholder="HH:MM">
            </div>
            ${tagsHTML}
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn active" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn active" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            <button class="btn btn-block" onclick="App.saveTask()">CONFIRM</button>
        `);
        setTimeout(() => document.getElementById('taskTitle').focus(), 100);
    }
    
    setPriority(p) {
        this.selectedPriority = p;
        document.querySelectorAll('[data-priority]').forEach(b => b.classList.toggle('active', b.dataset.priority === p));
        this.playSound(440, 0.03);
    }
    
    setXP(x) {
        this.selectedXP = x;
        document.querySelectorAll('[data-xp]').forEach(b => b.classList.toggle('active', parseInt(b.dataset.xp) === x));
        this.playSound(550, 0.03);
    }
    
    async saveTask() {
        const title = document.getElementById('taskTitle').value.trim();
        if (!title) return this.toast('ERROR: Enter task name');
        
        const deadlineTime = document.getElementById('taskDeadline').value;
        const taskDate = document.getElementById('taskDate').value || this.today();
        let deadline = null;
        if (deadlineTime) {
            deadline = taskDate + 'T' + deadlineTime;
        }
        
        const task = {
            id: 't_' + Date.now(),
            title,
            text: title,
            date: taskDate,
            deadline: deadline,
            priority: this.selectedPriority,
            xp: this.selectedXP,
            done: false,
            created: new Date().toISOString(),
            tags: [...this.selectedTags],
            subtasks: []
        };
        
        await this.dbPut('tasks', task);
        this.tasks.push(task);
        
        this.playSound(523, 0.08);
        this.closeModal();
        this.toast('TASK REGISTERED');
        this.render();
    }
    
    async showTask(id) {
        const t = this.tasks.find(x => x.id === id);
        if (!t) return;
        
        this.showModal('TASK DOSSIER', `
            <div style="display:flex;gap:15px;align-items:flex-start;margin-bottom:18px;">
                <div class="dither-frame" style="width:48px;flex-shrink:0;">
                    <div class="dither-frame-inner" style="height:48px;">
                        ${this.icon(t.done ? 'documentDone' : 'document', 'mac-icon-lg')}
                        <div class="dither-overlay"></div>
                    </div>
                </div>
                <div class="dossier-grid" style="flex:1;">
                    <span class="dossier-label">ID</span>
                    <span class="dossier-value">${t.id.slice(-8).toUpperCase()}</span>
                    <span class="dossier-label">STATUS</span>
                    <span class="dossier-value">${t.done ? 'COMPLETED' : 'ACTIVE'}</span>
                </div>
            </div>
            <div class="dossier-grid" style="margin-bottom:18px;">
                <span class="dossier-label">TITLE</span>
                <span class="dossier-value">${this.esc(t.title || t.text)}</span>
                <span class="dossier-label">DATE</span>
                <span class="dossier-value">${t.date || '--'}</span>
                <span class="dossier-label">PRIORITY</span>
                <span class="dossier-value" style="color:${t.priority === 'high' ? 'var(--danger)' : t.priority === 'medium' ? 'var(--warning)' : 'var(--fg)'}">${(t.priority || 'LOW').toUpperCase()}</span>
                <span class="dossier-label">REWARD</span>
                <span class="dossier-value" style="color:var(--warning)">+${t.xp || 10} XP</span>
            </div>
            ${t.tags && t.tags.length > 0 ? `
                <div style="margin-bottom:15px;">
                    <span class="dossier-label">TAGS:</span>
                    ${t.tags.map(tid => {
                        const tag = this.tags.find(tg => tg.id === tid);
                        return tag ? `<span class="tag-inline" style="color:${tag.color};">#${tag.name}</span>` : '';
                    }).join('')}
                </div>
            ` : ''}
            ${!t.done ? `
                <div style="margin-bottom:15px;border:1px solid var(--fg-dark);padding:12px;">
                    <div class="dossier-label" style="margin-bottom:10px;">SUBTASKS [${(t.subtasks||[]).filter(s=>s.done).length}/${(t.subtasks||[]).length}]</div>
                    <div class="subtasks-list">
                        ${(t.subtasks||[]).map((s, i) => `
                            <div class="subtask-item">
                                <button class="subtask-checkbox" onclick="App.toggleSubtask('${t.id}', ${i}); App.showTask('${t.id}');">
                                    ${s.done ? '‚úì' : ''}
                                </button>
                                <span class="subtask-text ${s.done?'done':''}">${this.esc(s.text)}</span>
                                <span class="subtask-del" onclick="App.delSubtask('${t.id}', ${i}); App.showTask('${t.id}');">[X]</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-subtask-row">
                        <input type="text" id="subtaskInput_${t.id}" placeholder="Add subtask...">
                        <button onclick="App.addSubtask('${t.id}')">+</button>
                    </div>
                </div>
            ` : ''}
            ${!t.done ? `
                <button class="btn btn-block" style="margin-bottom:12px;border-color:var(--accent);color:var(--accent);" onclick="App.initBoss('${id}')">‚ò† BOSS BATTLE</button>
                <button class="btn btn-block" style="margin-bottom:12px;" onclick="App.completeTask('${id}')">‚úì COMPLETE</button>
                <button class="btn btn-block" style="margin-bottom:12px;" onclick="App.editTask('${id}')">‚úé EDIT</button>
            ` : ''}
            <button class="btn btn-danger btn-block" onclick="App.deleteTask('${id}')">‚úï DELETE</button>
        `);
    }
    
    // Quick toggle from inline checkbox
    async quickToggle(id) {
        const t = this.tasks.find(x => x.id === id);
        if (!t) return;
        
        if (t.done) {
            // Undo completion
            t.done = false;
            t.doneAt = null;
            await this.dbPut('tasks', t);
            this.playSound(330, 0.05);
            this.toast('TASK REOPENED');
        } else {
            // Complete task
            t.done = true;
            t.doneAt = new Date().toISOString();
            await this.dbPut('tasks', t);
            
            let xpGained = t.xp || 10;
            
            // XP Boost check
            if (this.user.xpBoostCount > 0) {
                xpGained *= 2;
                this.user.xpBoostCount--;
                this.toast(`üöÄ XP BOOST! +${xpGained} XP`);
            }
            // Lucky Bonus (5% chance)
            else if (this.rollLuckyBonus()) {
                const mult = this.getLuckyMultiplier();
                xpGained *= mult;
                this.toast(`üçÄ LUCKY x${mult}! +${xpGained} XP`);
            } else {
                this.toast('+' + xpGained + ' XP');
            }
            
            this.playSound(659, 0.1);
            this.user.totalXPEarned = (this.user.totalXPEarned || 0) + xpGained;
            this.user.total = (this.user.total || 0) + 1;
            await this.addXP(xpGained);
            await this.updateStreak();
            await this.updateQuestProgress();
            
            // RPG Integration
            if (t.priority === 'high') await this.addStat('focus', 2);
            else await this.addStat('focus', 1);
            
            if (t.deadline && new Date() < new Date(t.deadline)) {
                await this.addStat('speed', 1);
            }
            
            await this.updateWeeklyProgress('tasks', 1);
            if (t.priority === 'high') await this.updateWeeklyProgress('high', 1);
            await this.updateCustomQuestProgress();
            await this.checkEpicQuests();
            await this.trackTaskTime();
            await this.checkMilestones();
            await this.saveUser();
            
            // Motivational message
            const msg = this.getMotivationalMessage();
            if (msg) setTimeout(() => this.toast(msg), 1500);
        }
        
        this.render();
    }
    
    async completeTask(id) {
        const t = this.tasks.find(x => x.id === id);
        if (!t || t.done) return;
        
        t.done = true;
        t.doneAt = new Date().toISOString();
        await this.dbPut('tasks', t);
        
        let xpGained = t.xp || 10;
        
        // XP Boost check
        if (this.user.xpBoostCount > 0) {
            xpGained *= 2;
            this.user.xpBoostCount--;
            this.toast(`üöÄ XP BOOST! +${xpGained} XP`);
        }
        // Lucky Bonus (5% chance)
        else if (this.rollLuckyBonus()) {
            const mult = this.getLuckyMultiplier();
            xpGained *= mult;
            this.toast(`üçÄ LUCKY x${mult}! +${xpGained} XP`);
        } else {
            this.toast('+' + xpGained + ' XP');
        }
        
        this.playSound(659, 0.1);
        await this.addXP(xpGained);
        await this.updateStreak();
        await this.updateQuestProgress();
        
        // RPG Integration
        this.user.totalXPEarned = (this.user.totalXPEarned || 0) + xpGained;
        this.user.total = (this.user.total || 0) + 1;
        
        // Update stats
        if (t.priority === 'high') await this.addStat('focus', 2);
        else await this.addStat('focus', 1);
        
        // Check deadline for speed stat
        if (t.deadline) {
            const deadline = new Date(t.deadline);
            if (new Date() < deadline) await this.addStat('speed', 1);
        }
        
        // Update weekly quest
        await this.updateWeeklyProgress('tasks', 1);
        if (t.priority === 'high') await this.updateWeeklyProgress('high', 1);
        
        // Octalysis enhancements
        await this.updateCustomQuestProgress();
        await this.checkEpicQuests();
        await this.trackTaskTime();
        await this.checkMilestones();
        
        await this.saveUser();
        this.closeModal();
        this.render();
        
        // Motivational message
        const msg = this.getMotivationalMessage();
        if (msg) setTimeout(() => this.toast(msg), 1500);
    }
    
    async deleteTask(id) {
        if (!confirm('DELETE THIS TASK?')) return;
        await this.dbDel('tasks', id);
        this.tasks = this.tasks.filter(x => x.id !== id);
        this.closeModal();
        this.toast('TASK DELETED');
        this.playSound(220, 0.1);
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê EDIT TASK ‚ïê‚ïê‚ïê
    async editTask(id) {
        const task = this.tasks.find(t => t.id === id);
        if (!task) return;
        
        this.selectedPriority = task.priority || 'medium';
        this.selectedXP = task.xp || 10;
        this.selectedTags = task.tags ? [...task.tags] : [];
        
        // Extract time from deadline
        let deadlineTime = '';
        if (task.deadline) {
            const parts = task.deadline.split('T');
            if (parts[1]) deadlineTime = parts[1].substring(0, 5);
        }
        
        const tagsHTML = this.tags.length > 0 ? `
            <div class="form-group">
                <label class="form-label">TAGS:</label>
                <div class="tags-row">
                    ${this.tags.map(t => `
                        <span class="tag tag-select ${this.selectedTags.includes(t.id)?'selected':''}" data-tagid="${t.id}"
                              style="border-color:${t.color};color:${this.selectedTags.includes(t.id)?'var(--bg)':t.color};background:${this.selectedTags.includes(t.id)?t.color:'transparent'};"
                              onclick="App.toggleTag('${t.id}')">#${t.name}</span>
                    `).join('')}
                </div>
            </div>` : '';
        
        this.showModal('EDIT TASK', `
            <div class="form-group">
                <label class="form-label">DESIGNATION:</label>
                <input type="text" class="input" id="editTaskTitle" value="${this.esc(task.title || task.text)}">
            </div>
            <div class="form-group">
                <label class="form-label">TARGET DATE:</label>
                <input type="date" class="input" id="editTaskDate" value="${task.date || this.today()}">
            </div>
            <div class="form-group">
                <label class="form-label">DEADLINE TIME (OPTIONAL):</label>
                <input type="time" class="input" id="editTaskDeadline" value="${deadlineTime}">
            </div>
            ${tagsHTML}
            <div class="form-group">
                <label class="form-label">PRIORITY:</label>
                <div class="select-row">
                    <button class="select-btn ${this.selectedPriority==='low'?'active':''}" data-priority="low" onclick="App.setPriority('low')">LOW</button>
                    <button class="select-btn ${this.selectedPriority==='medium'?'active':''}" data-priority="medium" onclick="App.setPriority('medium')">MED</button>
                    <button class="select-btn ${this.selectedPriority==='high'?'active':''}" data-priority="high" onclick="App.setPriority('high')">HIGH</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn ${this.selectedXP===5?'active':''}" data-xp="5" onclick="App.setXP(5)">+5</button>
                    <button class="select-btn ${this.selectedXP===10?'active':''}" data-xp="10" onclick="App.setXP(10)">+10</button>
                    <button class="select-btn ${this.selectedXP===20?'active':''}" data-xp="20" onclick="App.setXP(20)">+20</button>
                    <button class="select-btn ${this.selectedXP===50?'active':''}" data-xp="50" onclick="App.setXP(50)">+50</button>
                </div>
            </div>
            <button class="btn btn-block" style="margin-bottom:12px;" onclick="App.updateTask('${id}')">[SAVE]</button>
            <button class="btn btn-danger btn-block" onclick="App.deleteTask('${id}')">[DELETE]</button>
        `);
    }
    
    async updateTask(id) {
        const task = this.tasks.find(t => t.id === id);
        if (!task) return;
        
        const title = document.getElementById('editTaskTitle').value.trim();
        if (!title) { this.toast('ENTER TASK NAME', 'error'); return; }
        
        const taskDate = document.getElementById('editTaskDate').value || this.today();
        const deadlineTime = document.getElementById('editTaskDeadline').value;
        let deadline = null;
        if (deadlineTime) {
            deadline = taskDate + 'T' + deadlineTime;
        }
        
        task.title = title;
        task.text = title;
        task.date = taskDate;
        task.deadline = deadline;
        task.priority = this.selectedPriority;
        task.xp = this.selectedXP;
        task.tags = [...this.selectedTags];
        
        await this.dbPut('tasks', task);
        this.tasks = await this.dbAll('tasks');
        this.closeModal();
        this.toast('TASK UPDATED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê EDIT HABIT ‚ïê‚ïê‚ïê
    async editHabit(id) {
        const habit = this.habits.find(h => h.id === id);
        if (!habit) return;
        
        this.selectedHabitXP = habit.xp || 5;
        
        this.showModal('EDIT HABIT', `
            <div class="form-group">
                <label class="form-label">HABIT NAME:</label>
                <input type="text" class="input" id="editHabitInput" value="${this.esc(habit.text)}">
            </div>
            <div class="form-group">
                <label class="form-label">XP REWARD:</label>
                <div class="select-row">
                    <button class="select-btn ${habit.xp===3?'active':''}" data-hxp="3" onclick="App.setHabitXP(3)">+3</button>
                    <button class="select-btn ${habit.xp===5?'active':''}" data-hxp="5" onclick="App.setHabitXP(5)">+5</button>
                    <button class="select-btn ${habit.xp===10?'active':''}" data-hxp="10" onclick="App.setHabitXP(10)">+10</button>
                </div>
            </div>
            <div class="dossier-grid" style="margin:15px 0;">
                <span class="dossier-label">STREAK</span>
                <span class="dossier-value" style="color:var(--warning);">üî• ${habit.streak} DAYS</span>
            </div>
            <button class="btn btn-block" style="margin-bottom:12px;" onclick="App.updateHabit('${id}')">[SAVE]</button>
            <button class="btn btn-danger btn-block" onclick="App.delHabit('${id}')">[DELETE]</button>
        `);
    }
    
    async updateHabit(id) {
        const habit = this.habits.find(h => h.id === id);
        if (!habit) return;
        
        const text = document.getElementById('editHabitInput').value.trim();
        if (!text) { this.toast('ENTER HABIT NAME', 'error'); return; }
        
        habit.text = text;
        habit.xp = this.selectedHabitXP;
        
        await this.dbPut('habits', habit);
        this.habits = await this.dbAll('habits');
        this.closeModal();
        this.toast('HABIT UPDATED');
        this.render();
    }
    
    // ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
    async exportData() {
        const d = { 
            tasks: this.tasks, 
            tags: this.tags,
            habits: this.habits,
            scheduled: this.scheduled,
            user: this.user, 
            exported: new Date().toISOString() 
        };
        const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = `nexus_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        this.toast('DATA EXPORTED');
    }
    
    importData() {
        const inp = document.createElement('input');
        inp.type = 'file';
        inp.accept = '.json';
        inp.onchange = async e => {
            try {
                const d = JSON.parse(await e.target.files[0].text());
                if (d.tasks) { for (const t of d.tasks) await this.dbPut('tasks', t); this.tasks = await this.dbAll('tasks'); }
                if (d.tags) { for (const t of d.tags) await this.dbPut('tags', t); this.tags = await this.dbAll('tags'); }
                if (d.habits) { for (const h of d.habits) await this.dbPut('habits', h); this.habits = await this.dbAll('habits'); }
                if (d.scheduled) { for (const s of d.scheduled) await this.dbPut('scheduled', s); this.scheduled = await this.dbAll('scheduled'); }
                if (d.user) { this.user = {...this.user, ...d.user}; await this.saveUser(); this.applyTheme(this.user.theme || 'green'); this.updateXP(); }
                this.toast('DATA IMPORTED');
                this.render();
            } catch { this.toast('IMPORT ERROR'); }
        };
        inp.click();
    }
    
    async clearDone() {
        if (!confirm('CLEAR ALL COMPLETED TASKS?')) return;
        for (const t of this.tasks.filter(x => x.done)) await this.dbDel('tasks', t.id);
        this.tasks = this.tasks.filter(x => !x.done);
        this.toast('CLEARED');
        this.render();
    }
    
    async resetAll() {
        if (!confirm('‚ö† ERASE ALL DATA?')) return;
        if (!confirm('CONFIRM RESET?')) return;
        await this.dbClear('tasks');
        await this.dbClear('tags');
        await this.dbClear('habits');
        await this.dbClear('scheduled');
        await this.dbClear('user');
        this.tasks = [];
        this.tags = [];
        this.habits = [];
        this.scheduled = [];
        this.user = { level: 1, xp: 0, total: 0, achievements: [], theme: 'green', streak: 0, bossWins: 0 };
        this.applyTheme('green');
        this.updateXP();
        this.toast('SYSTEM RESET');
        this.render();
    }
    
    toast(m) {
        const t = document.getElementById('toast');
        t.textContent = m;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
    
    esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
}

const App = new NexusTerminal();
document.addEventListener('DOMContentLoaded', () => App.boot());
window.App = App;
</script>
</body>
</html>
